<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title>Mallit ja tietokanta</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="../../css/base.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script src="../../javascript/jquery.min.js"></script>
  <script src="../../javascript/bootstrap.js"></script>
  <script src="../../javascript/jquery.treeview.js"></script>
  <script src="../../javascript/jquery.scrollTo.js"></script>
  <script src="../../javascript/jquery.nav.js"></script>
  <script src="../../javascript/navi.js"></script>
</head>
<body>
<div class="titlebar">
  <div class="container">
    <div class="row">
      <h1 class="col-md-6 col-md-offset-3">Advanced Kittenry - Tietokantasovellusohjeet</h1>
    </div>
  </div>
</div>
<div class="container">
<div class="row">
<div class="navcontainer col-md-3">
<nav>
<ul>
<li><a href="../../index.html">Tietokantasovellus</a>
<ul>
<li><a href="../../aikataulu/index.html">Aikataulu</a>
<ul>
<li><a href="../../aikataulu/viikko1/index.html">Viikko 1</a>
<ul>
<li><a href="../../aikataulu/viikko1/ohjelmointikielet.html">Ohjelmointikielen valinta</a></li>
<li><a href="../../aikataulu/viikko1/tietokannat.html">Tietokannan valinta</a></li>
<li><a href="../../aikataulu/viikko1/tekniikka.html">Koodausympäristön pystytys</a></li>
<li><a href="../../aikataulu/viikko1/dokumentointi.html">Dokumentaation aloittaminen</a></li>
<li><a href="../../aikataulu/viikko1/git-ohje.html">Versionhallinta</a></li>
</ul></li>
<li><a href="../../aikataulu/viikko2/index.html">Viikko 2</a>
<ul>
<li><a href="../../aikataulu/viikko2/suunnittelu.html">Käyttöliittymän suunnittelu</a></li>
<li><a href="../../aikataulu/viikko2/tietokanta.html">Tietokannan suunnittelu</a></li>
</ul></li>
<li><a href="../../aikataulu/viikko3/index.html">Viikko 3</a>
<ul>
<li><a href="../../aikataulu/viikko3/java/index.html">Kirjautuminen Javalla</a>
<ul>
<li><a href="../../aikataulu/viikko3/java/rakenne.html">Sovelluksen rakenne ja servletit</a></li>
<li><a href="../../aikataulu/viikko3/java/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../aikataulu/viikko3/java/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
</ul></li>
<li><a href="../../aikataulu/viikko3/php/index.html">Kirjautuminen PHP:llä</a>
<ul>
<li><a href="../../aikataulu/viikko3/php/rakenne.html">Mihin eri tiedostot kannattaa laittaa?</a></li>
<li><a href="../../aikataulu/viikko3/php/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../aikataulu/viikko3/php/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
</ul></li>
</ul></li>
<li><a href="../../aikataulu/demo.html">Demotilaisuus</a></li>
<li><a href="../../aikataulu/palautus.html">Työn palautus</a></li>
</ul></li>
<li><a href="../../ohjeistus/index.html">Ohjeistus</a>
<ul>
<li><a href="../../ohjeistus/html-opas.html">HTML-opas</a></li>
<li><a href="../../ohjeistus/git-ja-salasanat.html">Git-repositoriot ja salasanat</a></li>
<li><a href="../../ohjeistus/netbeans/index.html">NetBeansin käyttöönotto</a>
<ul>
<li><a href="../../ohjeistus/netbeans/java.html">NetBeansin käyttö Javan kanssa</a></li>
<li><a href="../../ohjeistus/netbeans/php.html">NetBeansin käyttö PHP:n kanssa</a></li>
<li><a href="../../ohjeistus/netbeans/keyring-reset.html">Unlock your keyring? - Avainnippujen nollaus</a></li>
</ul></li>
<li><a href="../../ohjeistus/tietokantaohjelmointi/index.html">Sovelluksen ohjelmointi</a>
<ul>
<li><a href="../../ohjeistus/tietokantaohjelmointi/kannan-alustus.html">Tietokantataulujen pystyttäminen</a></li>
<li><a href="../../ohjeistus/tietokantaohjelmointi/testisovellus.html">ConnectionTest-testisovellus</a></li>
<li><a href="../../ohjeistus/tietokantaohjelmointi/tietokantayhteys/index.html">Tietokantayhteyden pystytys</a></li>
<li><a href="../../ohjeistus/tietokantaohjelmointi/listaustesti/index.html">Yksinkertainen tietokantalistaus</a>
<ul>
<li><a href="../../ohjeistus/tietokantaohjelmointi/listaustesti/java.html">Listaus Javalla</a></li>
<li><a href="../../ohjeistus/tietokantaohjelmointi/listaustesti/php.html">Listaus PHP:llä</a></li>
</ul></li>
<li><a href="../../ohjeistus/tietokantaohjelmointi/arkkitehtuuri/index.html">Arkkitehtuuri ja MVC</a>
<ul>
<li><a href="../../ohjeistus/tietokantaohjelmointi/arkkitehtuuri/nyrkkisaannot.html">MVC-mallin nyrkisääntöjä</a></li>
</ul></li>
</ul></li>
<li><a href="../../ohjeistus/users/index.html">Users-palvelin ja töiden pystyttäminen</a>
<ul>
<li><a href="../../ohjeistus/users/kayttoonotto/index.html">Palvelujen käynnistäminen ja käyttöönotto</a>
<ul>
<li><a href="../../ohjeistus/users/kayttoonotto/java.html">Java ja Tomcatin käyttöönotto</a></li>
<li><a href="../../ohjeistus/users/kayttoonotto/mysql.html">MySql-tietokannan käyttöönotto</a></li>
<li><a href="../../ohjeistus/users/kayttoonotto/php.html">PHP-tuen käyttöönotto</a></li>
<li><a href="../../ohjeistus/users/kayttoonotto/postgresql.html">PostgreSQL-tietokannan käyttöönotto</a></li>
</ul></li>
<li><a href="../../ohjeistus/users/postgres-ssh-tunneli.html">PostgreSql-kannan etäkäyttö</a></li>
<li><a href="../../ohjeistus/users/java-war-paketit.html">Kotikoneella tehdyn Java-työn julkaisu</a></li>
<li><a href="../../ohjeistus/users/php-virheet.html">PHP:n virheilmoitusten katselu</a></li>
<li><a href="../../ohjeistus/users/nautilus-ssh.html">Tiedostojen etämuokkaus Linuxilla</a></li>
</ul></li>
</ul></li>
<li><a href="../../aiheet/index.html">Työaiheet</a>
<ul>
<li><a href="../../aiheet/Drinkkiarkisto.html">Drinkkiarkisto</a></li>
<li><a href="../../aiheet/Elektroninen_keittokirja.html">Elektroninen keittokirja</a></li>
<li><a href="../../aiheet/Graduaiheet.html">Graduaiheet</a></li>
<li><a href="../../aiheet/Harjoitustyon_seuranta.html">Harjoitustyön seuranta</a></li>
<li><a href="../../aiheet/Hiihtokisojen_tulospalvelu.html">Hiihtokisojen tulospalvelu</a></li>
<li><a href="../../aiheet/Huutokauppa.html">Huutokauppa</a></li>
<li><a href="../../aiheet/Kennelkerho.html">Kennelkerho</a></li>
<li><a href="../../aiheet/Kuluttajan_tuki_Ry.html">Kuluttajan tuki Ry</a></li>
<li><a href="../../aiheet/Kurssikysely.html">Kurssikysely</a></li>
<li><a href="../../aiheet/Kurssin_kotisivu.html">Kurssin kotisivu</a></li>
<li><a href="../../aiheet/Kurssitarjonta_ja_kurssipaikan_varaus.html">Kurssitarjonta ja kurssipaikan varaus</a></li>
<li><a href="../../aiheet/Lainahakemusten_kasittely.html">Lainahakemusten käsittely</a></li>
<li><a href="../../aiheet/Laakariaseman_tyovuorolista.html">Lääkäriaseman työvuorolista</a></li>
<li><a href="../../aiheet/Laakarin_kotikaynnit.html">Lääkärin kotikäynnit</a></li>
<li><a href="../../aiheet/Matkojen_markkinointi.html">Matkojen markkinointi</a></li>
<li><a href="../../aiheet/Muistilista.html">Muistilista</a></li>
<li><a href="../../aiheet/Ostoskassi.html">Ostoskassi</a></li>
<li><a href="../../aiheet/Painontarkkailu.html">Painontarkkailu</a></li>
<li><a href="../../aiheet/Palvelubisnes.html">Palvelubisnes</a></li>
<li><a href="../../aiheet/Parturi-Kampaamo.html">Parturi-Kampaamo</a></li>
<li><a href="../../aiheet/Pizzapalvelu.html">Pizzapalvelu</a></li>
<li><a href="../../aiheet/Projektin_tyoaikaseuranta.html">Projektin työaikaseuranta</a></li>
<li><a href="../../aiheet/Rankkauslista.html">Rankkauslista</a></li>
<li><a href="../../aiheet/Taloyhtion_palvelut.html">Taloyhtiön palvelut</a></li>
<li><a href="../../aiheet/Tavaranvaihto.html">Tavaranvaihto</a></li>
<li><a href="../../aiheet/Tukkuliikkeen_tilaustenksittely.html">Tukkuliikkeen tilaustenkäsittely</a></li>
<li><a href="../../aiheet/Tutkimusaineston_kerays.html">Tutkimusaineiston keräys</a></li>
<li><a href="../../aiheet/Tyoaihekanta.html">Työaihekanta</a></li>
<li><a href="../../aiheet/Tyontekijanvuokraus_kotitoihin.html">Työntekijänvuokraus kotitöihin</a></li>
<li><a href="../../aiheet/Tyryhmtiedotus.html">Työryhmätiedotus</a></li>
<li><a href="../../aiheet/Opintoneuvonnan_usein_kysytyt_kysymykset.html">Usein kysytyt kysymykset</a></li>
<li><a href="../../aiheet/Vedonlyonti.html">Vedonlyönti</a></li>
<li><a href="../../aiheet/Vuokra-asuntojen_valitys.html">Vuokra-asuntojen välitys</a></li>
<li><a href="../../aiheet/Ystavanvalityspalvelu.html">Ystävänvälityspalvelu</a></li>
<li><a href="../../aiheet/Aanestys.html">Äänestys</a></li>
</ul></li>
<li><a href="../../arvosteluperusteet.html">Arvosteluperusteet</a></li>
<li><a href="../../dokumentaatio-ohje.html">Dokumentaatio-ohje</a></li>
<li><a href="../../cleancode.html">Hyvä ohjelmointityyli</a></li>
<li><a href="../../kaytettavyys.html">Käytettävyys</a></li>
<li><a href="../../sivukartta.html">Sivukartta</a></li>
<li><a href="../../web-sovelluksista.html">Web-sovelluksien toiminta</a></li>
</ul></li>
</ul>
</nav>
</div>
<div class="col-md-6" id="content">
<header>
<h1 class="title">Mallit ja tietokanta</h1>
</header>
<!-- order: 3 -->


<div class="wip panel">
  <div class="panel-body">
    <h3>
Work in progress
</h3>
    
Tämän sivun sisältö on vielä työn alla ja saattaa muuttua kurssin edetessä.
</div>
</div>



<section class="alert alert-info"><h3>
Tiivistelmä:
</h3>
<ul>
<li>Käytännössä jokaista tietokohdetta vastaa yksi malliluokka.
<ul>
<li>Puhtaille välitauluille harvemmin tarvitaan omaa luokkaansa, vaan niiden toiminnot hoidetaan itse tietokohteiden kautta.</li>
<li>Luokka sisältää tarvittavat metodit.</li>
<li>Käytetään sekä instanssimetodeja, että staattisia metodeja.
<ul>
<li>Instanssimetodit käsittelevät yksittäiseen taulun riviin liittyvää tietoa.</li>
<li>Staattiset metodit hakevat kannasta olioita sekä päivittävät tai poistavat kannasta useita olioita kerralla.</li>
<li>Oliolla kannattaa yleensä olla metodi, jolla se osaa syöttää itsensä kantaan (INSERT-lause).</li>
<li>Päivittämiseen tarvitaan vastaavaa metodia, joka ajaa UPDATE-lauseen, samoin poistamiselle on tarpeen DELETE-lauseen ajava instanssimetodi.</li>
</ul></li>
</ul></li>
<li>Käytetyn SQL-koodin pitää olla turvallista niin, ettei se tarjoa mahdollisuuksia SQL-injektioille. Tähän käytetään PDO:n ja javan JDBC:n prepared statements -tukia.</li>
</ul>
</section>

<section id="turvallinen-tietokantaohjelmointi" class="level2">
<h2>Turvallinen tietokantaohjelmointi</h2>
<p>Olennainen osa järkevää tietokantaohjelmointia on nk. <a href="http://fi.wikipedia.org/wiki/SQL-injektio">SQL-injektioiden</a> välttäminen.</p>
<p>Sovellukseen on mahdollista tehdä SQL-injektio silloin, kun käyttäjän antamia syötteitä ei tarkisteta kunnolla vaan ne upotetaan SQL-kyselyihin sellaisinaan. Esimerkki PHP:llä:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">$nimi</span> = <span class="kw">$_POST</span><span class="ot">[</span><span class="st">&#39;nimi&#39;</span><span class="ot">];</span>

<span class="kw">$yhteys</span> = Tietokanta::getYhteys<span class="ot">();</span>
<span class="kw">$kysely</span> = <span class="kw">$yhteys</span>-&gt;prepare<span class="ot">(</span><span class="st">&quot;SELECT * FROM users WHERE nimi = &#39;</span><span class="kw">$nimi</span><span class="st">&#39;&quot;</span><span class="ot">);</span></code></pre>
<p>Nyt, mikäli nimeksi annetaankin vaikka merkkijono <code>' OR username = 'admin'</code>, hakeekin kysely kannasta aivan eri käyttäjän kuin pitäisi!</p>
<p>Jos tälläinen virhe eksyy vaikkapa kirjautumislogiikkaan, on sovellus auttamatta haavoittuvainen murtautumisyrityksille.</p>
<p>Onneksi sekä PHP:llä että Javalla on olemassa hyvin helppokäyttöinen tapa estää tälläisiä kyselyjä menemästä kantaan: <a href="http://en.wikipedia.org/wiki/Prepared_statement">Prepared statementit</a> eli kankeasti suomennettuna esivalmistellut SQL-lauseet ovat ratkaisu ongelmaan.</p>
<p>Käytännössä kyseessä on tietokannalle etukäteen lähetetty SQL-kielinen kysely, johon on upotettu paikkoja parametreille. Näiden parametrien paikalle voi sitten upottaa haluamiaan arvoja.</p>
<p>Sekä PHP:ssä että Javassa parametrien paikkoja ilmaistaan kysymysmerkeillä. Kielien tapa syöttää kyselylle parametrejä on hieman erilainen: PHP:llä parametrit annetaan array-tyyppisenä listana <a href="http://php.net/manual/en/pdostatement.execute.php">kyselyä suoritettaessa</a> Java:lla ne asetetaan kyselylle jokainen erikseen erilaisilla metodikutsuilla. Joka tyypille on omansa, esim. merkkijonoille <a href="http://docs.oracle.com/javase/7/docs/api/java/sql/PreparedStatement.html#setString(int,%20java.lang.String)">setString</a>. Huomaa, että Javalla kyselyn parametrien indeksointi alkaa ykkösestä.</p>
<div class="row">
<div class="col-md-6">

<p><strong>PHP</strong></p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">$nimi</span> = <span class="kw">$_POST</span><span class="ot">[</span><span class="st">&#39;nimi&#39;</span><span class="ot">];</span>
<span class="kw">$yhteys</span> = Tietokanta::getYhteys<span class="ot">();</span>

<span class="co">//Etsitään käyttäjää nimellä</span>
<span class="kw">$sql</span> = <span class="st">&quot;SELECT * FROM users WHERE nimi = ?&quot;</span><span class="ot">;</span>
<span class="kw">$kysely</span> = <span class="kw">$yhteys</span>-&gt;prepare<span class="ot">(</span><span class="kw">$sql</span><span class="ot">);</span>

<span class="co">//Annetaan yksi parametri array:n sisällä</span>
<span class="kw">$tulokset</span> = <span class="kw">$kysely</span>-&gt;execute<span class="ot">(</span><span class="fu">array</span><span class="ot">(</span><span class="kw">$nimi</span><span class="ot">));</span></code></pre>
</div>
<div class="col-md-6">

<p><strong>Java</strong></p>
<pre class="sourceCode java"><code class="sourceCode java">Connection yhteys = <span class="kw">null</span>;
PreparedStatement kysely = <span class="kw">null</span>;
ResultSet tulokset = <span class="kw">null</span>;

String nimi = request.<span class="fu">getParameter</span>(<span class="st">&quot;nimi&quot;</span>);
yhteys = TietokantaYhteydet.<span class="fu">getYhteys</span>();

<span class="co">//Etsitään käyttäjää nimellä</span>
String sql = <span class="st">&quot;SELECT * FROM users WHERE nimi = ?&quot;</span>;
kysely = yhteys.<span class="fu">prepareStatement</span>(sql);

<span class="co">//Annetaan yksi parametri array:n sisällä</span>
kysely.<span class="fu">setString</span>(<span class="dv">1</span>, nimi);
tulokset = kysely.<span class="fu">executeQuery</span>();</code></pre>
</div>
</div>

</section>
<section id="mallien-rakentaminen" class="level2">
<h2>Mallien rakentaminen</h2>
<ul>
<li>Tähän on olemassa monia tapoja.</li>
<li>Selkeä: Joka tietokantataululle oma luokkansa.
<ul>
<li>Jokainen olio edustaa yhtä taulunsa riviä.</li>
<li>Poikkeus: liitostauluille ei välttämättä tarvita omaa luokkaansa, mikäli niiden toiminnot voi loogisesti sijoittaa muihinkin luokkiin.</li>
</ul></li>
<li>Luokalla staattisia metodeja, joilla voi hakea olioita eli rivejä kannasta.
<ul>
<li>Voi tehdä myös instassimetodeja, jotka hakevat johonkin olioon liittyviä rivejä toisista tietokantatauluista.</li>
</ul></li>
<li>Tarvitaan myös metodit, joka syöttävät olion kantaan tai päivittävät kannassa olevia tietoja olion perusteella.
<ul>
<li>Näitä mahdollista tehdä ilman oliotakin.</li>
<li>Voivat olla staattisia tai instassimetodeja.</li>
</ul></li>
<li>Lopuksi metodi(t), jolla voi poistaa rivejä.
<ul>
<li>Instanssimetodi poistaa kyseisen olion kannasta.</li>
<li>Staattisella metodilla voi poistaa useitakin olioita.</li>
</ul></li>
</ul>
<section id="olion-syöttäminen-kantaan" class="level3">
<h3>Olion syöttäminen kantaan</h3>
<ul>
<li>Autogeneroituja id-numeroita (esim. PostgreSQL:n <a href="http://www.postgresql.org/docs/9.2/static/datatype-numeric.html#DATATYPE-SERIAL">SERIAL-tietotyyppi</a>) varten olemassa omat kikkansa:
<ul>
<li>PostgreSQL:llä voidaan INSERT-lauseen jälkeen laittaa käsky <code>RETURNING id</code>, jolloin kysely palauttaa kentän <code>id</code> arvon ikään kuin se olisi SELECT-kysely.</li>
<li>MySQL:llä olemassa PHP:llä PDO:n <a href="http://php.net/manual/en/pdo.lastinsertid.php">lastInsertId-metodi</a>.</li>
<li>Javalle olemassa <a href="http://www.technicalkeeda.com/details/how-to-get-mysql-auto-increment-key-value-using-java-jdbc">vastaava tekniikka</a>.</li>
<li>SERIAL-tyyppiä käytettäessä INSERT-lauseeseen ei laiteta id-avaimelle lainkaan arvoa, jolloin kanta laittaa kenttään seuraavan vapaan arvon.</li>
</ul></li>
</ul>
<section class="alert alert-success small"><h3>
Seuraavaksi:
</h3>
<p>Kun malli on toteutettu, sitä voi käyttää <a href="nakymat.html">näkymissä</a>.</p>
</section>




</section>
</section>
</div>
</div> 
</div> 
<footer>
  <a href="../../sivukartta.html">Sivukartta</a> - 
  <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">AdvancedKittenry</span> 
  by
  <a xmlns:cc="http://creativecommons.org/ns#" href="http://advancedkittenry.github.io/credits.html" property="cc:attributionName" rel="cc:attributionURL">David Consuegra and others</a>
  is licensed under a 
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" />
  </a>
</footer>
</body>
</html>
