<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title>Sovelluksen rakenne ja kontrollerit</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="../../css/base.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script src="../../javascript/jquery.min.js"></script>
  <script src="../../javascript/bootstrap.js"></script>
  <script src="../../javascript/jquery.treeview.js"></script>
  <script src="../../javascript/jquery.scrollTo.js"></script>
  <script src="../../javascript/jquery.nav.js"></script>
  <script src="../../javascript/navi.js"></script>
</head>
<body>
<div class="titlebar">
  <div class="container">
    <div class="row">
      <h1 class="col-md-6 col-md-offset-3">Advanced Kittenry - Tietokantasovellusohjeet</h1>
    </div>
  </div>
</div>
<div class="container">
<div class="row">
<div class="navcontainer col-md-3">
<nav>
<ul>
<li><a href="../../index.html">Tietokantasovellus</a>
<ul>
<li><a href="../../aikataulu/index.html">Aikataulu</a>
<ul>
<li><a href="../../aikataulu/viikkopalautukset/index.html">Viikottaiset palautukset</a>
<ul>
<li><a href="../../aikataulu/viikkopalautukset/esittelysivu.html">Työn esittelysivu</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko1.html">Viikko 1</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko2.html">Viikko 2</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko3.html">Viikko 3</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko4.html">Viikko 4</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko5.html">Viikko 5</a></li>
</ul></li>
<li><a href="../../aikataulu/demo.html">Demotilaisuus</a></li>
<li><a href="../../aikataulu/palautus.html">Työn palautus</a></li>
</ul></li>
<li><a href="../../suunnittelu/index.html">Työn suunnittelu</a>
<ul>
<li><a href="../../suunnittelu/aiheet/index.html">Työaiheet</a>
<ul>
<li><a href="../../suunnittelu/aiheet/Drinkkiarkisto.html">Drinkkiarkisto</a></li>
<li><a href="../../suunnittelu/aiheet/Elektroninen_keittokirja.html">Elektroninen keittokirja</a></li>
<li><a href="../../suunnittelu/aiheet/Graduaiheet.html">Graduaiheet</a></li>
<li><a href="../../suunnittelu/aiheet/Hiihtokisojen_tulospalvelu.html">Hiihtokisojen tulospalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Huutokauppa.html">Huutokauppa</a></li>
<li><a href="../../suunnittelu/aiheet/Kennelkerho.html">Kennelkerho</a></li>
<li><a href="../../suunnittelu/aiheet/Keskustelufoorumi.html">Keskustelufoorumi</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssikysely.html">Kurssikysely</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssin_kotisivu.html">Kurssin kotisivu</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssitarjonta_ja_kurssipaikan_varaus.html">Kurssitarjonta ja kurssipaikan varaus</a></li>
<li><a href="../../suunnittelu/aiheet/Laakariaseman_tyovuorolista.html">Lääkäriaseman työvuorolista</a></li>
<li><a href="../../suunnittelu/aiheet/Laakarin_kotikaynnit.html">Lääkärin kotikäynnit</a></li>
<li><a href="../../suunnittelu/aiheet/Matkojen_markkinointi.html">Matkojen markkinointi</a></li>
<li><a href="../../suunnittelu/aiheet/Muistilista.html">Muistilista</a></li>
<li><a href="../../suunnittelu/aiheet/Ostoskassi.html">Ostoskassi</a></li>
<li><a href="../../suunnittelu/aiheet/Palvelubisnes.html">Palvelubisnes</a></li>
<li><a href="../../suunnittelu/aiheet/Parturi-Kampaamo.html">Parturi-Kampaamo</a></li>
<li><a href="../../suunnittelu/aiheet/Pizzapalvelu.html">Pizzapalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Pokemon-kanta.html">Pokémon-tietokanta</a></li>
<li><a href="../../suunnittelu/aiheet/Projektin_tyoaikaseuranta.html">Projektin työaikaseuranta</a></li>
<li><a href="../../suunnittelu/aiheet/Rankkauslista.html">Rankkauslista</a></li>
<li><a href="../../suunnittelu/aiheet/Taloyhtion_palvelut.html">Taloyhtiön palvelut</a></li>
<li><a href="../../suunnittelu/aiheet/Tavaranvaihto.html">Tavaranvaihto</a></li>
<li><a href="../../suunnittelu/aiheet/Tukkuliikkeen_tilaustenksittely.html">Tukkuliikkeen tilaustenkäsittely</a></li>
<li><a href="../../suunnittelu/aiheet/Tutkimusaineston_kerays.html">Tutkimusaineiston keräys</a></li>
<li><a href="../../suunnittelu/aiheet/Tyoaihekanta.html">Työaihekanta</a></li>
<li><a href="../../suunnittelu/aiheet/Opintoneuvonnan_usein_kysytyt_kysymykset.html">Usein kysytyt kysymykset</a></li>
<li><a href="../../suunnittelu/aiheet/Vedonlyonti.html">Vedonlyönti</a></li>
<li><a href="../../suunnittelu/aiheet/Vuokra-asuntojen_valitys.html">Vuokra-asuntojen välitys</a></li>
<li><a href="../../suunnittelu/aiheet/Ystavanvalityspalvelu.html">Ystävänvälityspalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Aanestys.html">Äänestys</a></li>
</ul></li>
<li><a href="../../suunnittelu/ohjelmointikielet.html">Ohjelmointikielen valinta</a></li>
<li><a href="../../suunnittelu/tietokannan-valinta.html">Tietokannan valinta</a></li>
<li><a href="../../suunnittelu/kayttoliittyma.html">Käyttöliittymän suunnittelu</a></li>
<li><a href="../../suunnittelu/tietokanta.html">Tietokannan suunnittelu</a></li>
</ul></li>
<li><a href="../../pystytys/index.html">Users-palvelin ja töiden pystyttäminen</a>
<ul>
<li><a href="../../pystytys/kayttoonotto/index.html">Palvelujen käynnistäminen ja käyttöönotto</a>
<ul>
<li><a href="../../pystytys/kayttoonotto/java.html">Java ja Tomcatin käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/mysql.html">MySql-tietokannan käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/php.html">PHP-tuen käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/postgresql.html">PostgreSQL-tietokannan käyttöönotto</a></li>
</ul></li>
<li><a href="../../pystytys/netbeans/index.html">NetBeansin käyttöönotto</a>
<ul>
<li><a href="../../pystytys/netbeans/java.html">NetBeansin käyttö Javan kanssa</a></li>
<li><a href="../../pystytys/netbeans/php.html">NetBeansin käyttö PHP:n kanssa</a></li>
<li><a href="../../pystytys/netbeans/keyring-reset.html">Unlock your keyring? - Avainnippujen nollaus</a></li>
</ul></li>
<li><a href="../../pystytys/postgres-ssh-tunneli.html">PostgreSql-kannan etäkäyttö</a></li>
<li><a href="../../pystytys/java-war-paketit.html">Kotikoneella tehdyn Java-työn julkaisu</a></li>
<li><a href="../../pystytys/php-virheet.html">PHP:n virheilmoitusten katselu</a></li>
<li><a href="../../pystytys/nautilus-ssh.html">Tiedostojen etämuokkaus Linuxilla</a></li>
</ul></li>
<li><a href="../../koodaaminen/index.html">Ohjelmointiohjeistus</a>
<ul>
<li><a href="../../koodaaminen/html-opas.html">HTML-opas</a></li>
<li><a href="../../koodaaminen/kannan-alustus.html">Tietokantataulujen pystyttäminen</a></li>
<li><a href="../../koodaaminen/testisovellus.html">ConnectionTest-testisovellus</a></li>
<li><a href="../../koodaaminen/tietokantayhteys/index.html">Tietokantayhteyden pystytys</a></li>
<li><a href="../../koodaaminen/git-ja-salasanat.html">Git-repositoriot ja salasanat</a></li>
<li><a href="../../koodaaminen/listaustesti/index.html">Yksinkertainen tietokantalistaus</a>
<ul>
<li><a href="../../koodaaminen/listaustesti/java.html">Listaus Javalla</a></li>
<li><a href="../../koodaaminen/listaustesti/php.html">Listaus PHP:llä</a></li>
</ul></li>
<li><a href="../../koodaaminen/arkkitehtuuri/index.html">Arkkitehtuuri ja MVC</a>
<ul>
<li><a href="../../koodaaminen/arkkitehtuuri/nyrkkisaannot.html">MVC-mallin nyrkisääntöjä</a></li>
</ul></li>
<li><a href="../../koodaaminen/java/index.html">Java-ohjeet</a>
<ul>
<li><a href="../../koodaaminen/java/rakenne.html">Sovelluksen rakenne ja servletit</a></li>
<li><a href="../../koodaaminen/java/nakymat.html">Näkymien tekeminen ja JSP</a></li>
<li><a href="../../koodaaminen/java/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../koodaaminen/java/tietokanta_kirjautuminen.html">Tietokannan käytön alkeet</a></li>
<li><a href="../../koodaaminen/java/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
<li><a href="../../koodaaminen/java/mallit_muokkaustoiminnot.html">Malliluokat ja tiedon muuttaminen</a></li>
<li><a href="../../koodaaminen/java/muokkausnakymat.html">Muokkausnäkymän toteuttaminen</a></li>
</ul></li>
<li><a href="../../koodaaminen/php/index.html">PHP-ohjeet</a>
<ul>
<li class="selected"><a href="../../koodaaminen/php/rakenne.html">Sovelluksen rakenne ja kontrollerit</a></li>
<li><a href="../../koodaaminen/php/nakymat.html">Näkymien tekeminen</a></li>
<li><a href="../../koodaaminen/php/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../koodaaminen/php/tietokanta_kirjautuminen.html">Tietokannan käytön alkeet</a></li>
<li><a href="../../koodaaminen/php/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
<li><a href="../../koodaaminen/php/mallit_muokkaustoiminnot.html">Malliluokat ja tiedon muuttaminen</a></li>
<li><a href="../../koodaaminen/php/muokkausnakymat.html">Muokkausnäkymän toteuttaminen</a></li>
</ul></li>
</ul></li>
<li><a href="../../arvosteluperusteet.html">Arvosteluperusteet</a></li>
<li><a href="../../dokumentaatio-ohje.html">Dokumentaatio-ohje</a></li>
<li><a href="../../cleancode.html">Hyvä ohjelmointityyli</a></li>
<li><a href="../../kaytettavyys.html">Käytettävyys</a></li>
<li><a href="../../sivukartta.html">Sivukartta</a></li>
<li><a href="../../web-sovelluksista.html">Web-sovelluksien toiminta</a></li>
</ul></li>
</ul>
</nav>
</div>
<div class="col-md-6" id="content">
<header>
<h1 class="title">Sovelluksen rakenne ja kontrollerit</h1>
</header>
<!-- order: 1 -->
<script>addSectionLinks = true; </script>

<section class="alert alert-info"><h3>
Tiivistelmä:
</h3>

<ul>
<li>Sovelluksen sivut ovat projektin juuressa olevia kontrollereita, jotka käyttävät malleja ja näkymiä.</li>
<li>Kaikki näkymät menevät kansioon <code>views</code></li>
<li>Tee sovelluksesi yleisesti käytetyille toiminnoille kirjastotiedosto, johon voi sijoittaa yleiskäyttöisiä toimintoja.</li>
<li>Kaikki kirjastotiedostot menevät omaan kansioonsa, esim. <code>libs</code>.</li>
<li>Mallit voi sijoittaa kirjastotiedostojen mukana omaan kansioonsa. Esim. <code>libs/models</code>.</li>
</ul>
<p>Lopullisen projektin pitäisi noudatella tämäntapaista kansiorakennetta</p>
<pre><code>views/
  userlist.php
libs/
  models/
    user.php
  utilities.php (Yleiskäyttöisiä funktioita)
users.php (Käyttäjänhallinnan kontrolleri)
~~~</code></pre>
</section>

<p>PHP on historialtaan ja luonteeltaan selkeä <a href="http://fi.wikipedia.org/wiki/Komentosarjakieli">skriptikieli</a>. Toisin kuin useimmat käännettävien ohjelmointikielien ohjelmat, PHP-ohjelmalla ei ole erityistä nimettyä alkukohtaa, vaan suoritus alkaa tiedoston alusta ja jatkuu siitä tiedoston loppuun, ellei sitä erikseen keskeytetä.</p>
<p>Lisäksi PHP eroaa hieman useimmista muista web-ohjelmointikielistä suoraviivaisessa lähestymisessään URL-osoitteiden ja suoritettavan ohjelmakoodin väliseen riippuvuuteen.</p>
<p>Perussääntö on hyvin yksinkertainen, jokainen tiedosto näkyy oman URL:insa takana sillä palvelimella, minne tiedostot on sijoitettu.</p>
<p>Eräänlaisena poikkeuksena toimivat etusivut: Jos syöttää osoitekenttään pelkän hakemiston osoitteen, esim. <code>http://tunnus.users.cs.helsinki.fi</code> on se sama kuin kirjoittaisi <code>http://tunnus.users.cs.helsinki.fi/index.php</code>, kunhan htdocs-kansiossa on <code>index.php</code>-tiedosto.</p>
<p>On periaatteessa täysin mahdollista tehdä php-sivuja, joissa jokainen ladattava sivu tuotetaan tasan yhdellä php-tiedostolla.</p>
<p>Tästä johtuen yksinkertaisin tapa toteuttaa yksittäisen toiminnon kontrolleri PHP:llä ei oikeastaan vaadi muuta kuin sopivaan osoitteeseen sijoitetun PHP-tiedoston, joka kutsuu tarvitsemiaan kirjastoja tuottaakseen käyttäjälle halutun vastauksen aineistopyyntöön.</p>
<section id="spagettikoodi-ja-kontrolleri" class="level2">
<h2>Spagettikoodi ja kontrolleri</h2>
<p>Tiiviimmillään ja rumimmillaan tämä näkyy vieläkin ikävän yleisenä <em>spagettikoodina</em>, jossa sovelluksen kaikki kolme osaa: kontrolleri, näkymä ja malli ovat sulassa sovussa ja sekasotkussa samassa tiedostossa. Lopputulos on vähänkään monimutkaisemmissa sovelluksissa sekava ja vaikea muuttaa.</p>
<p><strong>spagettikoodi.php</strong></p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span>
  <span class="kw">include</span> <span class="st">&#39;tietokantayhteys.php&#39;</span><span class="ot">;</span>
  <span class="kw">$yhteys</span> = <span class="kw">new</span> <span class="kw">PDO</span><span class="ot">(</span><span class="st">&#39;pgsql:&#39;</span><span class="ot">);</span>
  <span class="kw">$nimi</span> = <span class="st">&#39;Matti&#39;</span><span class="ot">;</span>
<span class="kw">?&gt;</span>&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;&lt;title&gt;PHP Page&lt;/title&gt;&lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;Hello <span class="kw">&lt;?php</span> <span class="kw">$nimi</span><span class="ot">;</span> <span class="kw">?&gt;</span>&lt;/h1&gt;
    <span class="kw">&lt;?php</span> 

      <span class="kw">$sql</span> = <span class="st">&quot;SELECT id, nimi, osoite FROM kayttajat WHERE ika &gt;= ? and sukunimi = ?&quot;</span><span class="ot">;</span>
      <span class="kw">$kysely</span> = <span class="kw">$yhteys</span>-&gt;prepare<span class="ot">(</span><span class="kw">$sql</span><span class="ot">);</span>
      <span class="kw">$tulokset</span> = <span class="kw">$kysely</span>-&gt;execute<span class="ot">(</span><span class="fu">array</span><span class="ot">(</span><span class="dv">18</span><span class="ot">,</span><span class="st">&quot;Lehtonen&quot;</span><span class="ot">));</span>
      <span class="co">//Tulostetaan tietoja löydetyistä käyttäjistä</span>
      <span class="kw">while</span><span class="ot">(</span><span class="kw">$rivi</span> = <span class="kw">$tulokset</span>-&gt;fetchObject<span class="ot">())</span> {
        <span class="fu">echo</span> <span class="st">&quot;&lt;div&gt;Käyttäjän </span><span class="kw">$rivi</span><span class="st">-&gt;etunimi </span><span class="kw">$rivi</span><span class="st">-&gt;sukunimi ikä on </span><span class="kw">$rivi</span><span class="st">-&gt;ika&lt;/div&gt;&quot;</span><span class="ot">;</span>
      }

    <span class="kw">?&gt;</span>
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Tällä kurssilla pyrimme hieman selkeämpään <a href="../../koodaaminen/arkkitehtuuri/index.html">arkkitehtuuriin</a>, jossa mallit ja näkymät määritellään omissa tiedostoissaan.</p>
<p>Tämä ei kuitenkaan varsinaisesti estä käyttämästä PHP:n suoraviivaista luonnetta siihen, että jätämme varsinaiset kontrollerit paljaaksi koodiksi, joka vain suoraan kutsuu erilaisia kirjastoja ja näyttää lopulta näkymän.</p>
<p>Esimerkkinä kuvitteellisen kissalistan kontrolleri:</p>
<p><strong>kissalista.php</strong></p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">&lt;?php</span> 
  <span class="co">//Otetaan käyttöön kirjastotiedosto, joka hakee kasan omatekoisia yleistoimintoja, sekä malliluokka:</span>
  <span class="kw">require_once</span> <span class="st">&#39;src/common.php&#39;</span><span class="ot">;</span>
  <span class="kw">require_once</span> <span class="st">&#39;src/models/kissa.php&#39;</span><span class="ot">;</span>
  
  <span class="co">//Selvitetään onko käyttäjä tehnyt haun</span>
  <span class="kw">$hakusana</span> = <span class="kw">null</span><span class="ot">;</span>
  <span class="kw">if</span> <span class="ot">(</span>!<span class="fu">empty</span><span class="ot">(</span><span class="kw">$_GET</span><span class="ot">[</span><span class="st">&#39;haku&#39;</span><span class="ot">]))</span> {
    <span class="kw">$hakusana</span> = <span class="kw">$_GET</span><span class="ot">[</span><span class="st">&#39;haku&#39;</span><span class="ot">];</span>
  }

  <span class="co">//Kutsutaan malliluokan staattista metodia</span>
  <span class="kw">$kissat</span> = Kissa::hae<span class="ot">(</span><span class="kw">$hakusana</span><span class="ot">);</span>
  
  <span class="co">//Näytetään näkymä lähettäen sille muutamia muuttujia</span>
  naytaNakymä<span class="ot">(</span><span class="st">&quot;kissalista&quot;</span><span class="ot">,</span> <span class="fu">array</span><span class="ot">(</span>
    <span class="st">&#39;title&#39;</span> =&gt; <span class="st">&quot;Kissalista&quot;</span><span class="ot">,</span>
    <span class="st">&#39;kissat&#39;</span> =&gt; <span class="kw">$kissat</span>
  <span class="ot">));</span></code></pre>
<p>Jotta yllä oleva esimerkki toimisi, on luotava sen tueksi malliluokat, näkymät ja muutama yleiskäyttöinen luokka ja funktio.</p>
</section>
<section id="mallit" class="level2">
<h2>Mallit</h2>
<p>Sijoita projektin mallit omaan kansioonsa kirjastokansiosi alle, siten että kussakin tiedostossa on yksi malliluokka.</p>
<p>Sijoita malliisi kentät tietokantataulun kenttiä varten ja luo kentille getterit ja setterit sekä halutessasi konstruktori, joka ottaa kenttien arvot vastaan.</p>
<p>Työn edetessä teemme luokkiin metodeja, jotka osaavat hakea olioihin sisältöä tietokannasta, sekä metodit, joilla tietoa päivitetään takaisin kantaan.</p>
<section class="alert alert-success small"><h3>
Seuraavaksi:
</h3>
<p>Seuraavaksi tutustumme tarkemmin <a href="nakymat.html">näkymien toteuttamiseen</a>.</p>
</section>




</section>
</div>
</div> 
</div> 
<footer>
  <a href="../../sivukartta.html">Sivukartta</a> - 
  <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">AdvancedKittenry</span> 
  by
  <a xmlns:cc="http://creativecommons.org/ns#" href="http://advancedkittenry.github.io/credits.html" property="cc:attributionName" rel="cc:attributionURL">David Consuegra and others</a>
  is licensed under a 
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" />
  </a>
</footer>
</body>
</html>
