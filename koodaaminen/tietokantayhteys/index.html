<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title>Tietokantayhteyden pystytys</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="../../css/base.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script src="../../javascript/jquery.min.js"></script>
  <script src="../../javascript/bootstrap.js"></script>
  <script src="../../javascript/jquery.treeview.js"></script>
  <script src="../../javascript/jquery.scrollTo.js"></script>
  <script src="../../javascript/jquery.nav.js"></script>
  <script src="../../javascript/navi.js"></script>
</head>
<body>
<div class="titlebar">
  <div class="container">
    <div class="row">
      <h1 class="col-md-6 col-md-offset-3">Advanced Kittenry - Tietokantasovellusohjeet</h1>
    </div>
  </div>
</div>
<div class="container">
<div class="row">
<div class="navcontainer col-md-3">
<nav>
<ul>
<li><a href="../../index.html">Tietokantasovellus</a>
<ul>
<li><a href="../../aikataulu/index.html">Aikataulu</a>
<ul>
<li><a href="../../aikataulu/viikko1.html">Viikko 1</a></li>
<li><a href="../../aikataulu/viikko2.html">Viikko 2</a></li>
<li><a href="../../aikataulu/viikko3.html">Viikko 3</a></li>
<li><a href="../../aikataulu/viikko4.html">Viikko 4</a></li>
<li><a href="../../aikataulu/viikko5.html">Viikko 5</a></li>
<li><a href="../../aikataulu/demo.html">Demotilaisuus</a></li>
<li><a href="../../aikataulu/palautus.html">Työn palautus</a></li>
</ul></li>
<li><a href="../../suunnittelu/index.html">Työn suunnittelu</a>
<ul>
<li><a href="../../suunnittelu/aiheet/index.html">Työaiheet</a>
<ul>
<li><a href="../../suunnittelu/aiheet/Drinkkiarkisto.html">Drinkkiarkisto</a></li>
<li><a href="../../suunnittelu/aiheet/Elektroninen_keittokirja.html">Elektroninen keittokirja</a></li>
<li><a href="../../suunnittelu/aiheet/Graduaiheet.html">Graduaiheet</a></li>
<li><a href="../../suunnittelu/aiheet/Harjoitustyon_seuranta.html">Harjoitustyön seuranta</a></li>
<li><a href="../../suunnittelu/aiheet/Hiihtokisojen_tulospalvelu.html">Hiihtokisojen tulospalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Huutokauppa.html">Huutokauppa</a></li>
<li><a href="../../suunnittelu/aiheet/Kennelkerho.html">Kennelkerho</a></li>
<li><a href="../../suunnittelu/aiheet/Kuluttajan_tuki_Ry.html">Kuluttajan tuki Ry</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssikysely.html">Kurssikysely</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssin_kotisivu.html">Kurssin kotisivu</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssitarjonta_ja_kurssipaikan_varaus.html">Kurssitarjonta ja kurssipaikan varaus</a></li>
<li><a href="../../suunnittelu/aiheet/Lainahakemusten_kasittely.html">Lainahakemusten käsittely</a></li>
<li><a href="../../suunnittelu/aiheet/Laakariaseman_tyovuorolista.html">Lääkäriaseman työvuorolista</a></li>
<li><a href="../../suunnittelu/aiheet/Laakarin_kotikaynnit.html">Lääkärin kotikäynnit</a></li>
<li><a href="../../suunnittelu/aiheet/Matkojen_markkinointi.html">Matkojen markkinointi</a></li>
<li><a href="../../suunnittelu/aiheet/Muistilista.html">Muistilista</a></li>
<li><a href="../../suunnittelu/aiheet/Ostoskassi.html">Ostoskassi</a></li>
<li><a href="../../suunnittelu/aiheet/Painontarkkailu.html">Painontarkkailu</a></li>
<li><a href="../../suunnittelu/aiheet/Palvelubisnes.html">Palvelubisnes</a></li>
<li><a href="../../suunnittelu/aiheet/Parturi-Kampaamo.html">Parturi-Kampaamo</a></li>
<li><a href="../../suunnittelu/aiheet/Pizzapalvelu.html">Pizzapalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Pokemon-kanta.html">Pokémon-tietokanta</a></li>
<li><a href="../../suunnittelu/aiheet/Projektin_tyoaikaseuranta.html">Projektin työaikaseuranta</a></li>
<li><a href="../../suunnittelu/aiheet/Rankkauslista.html">Rankkauslista</a></li>
<li><a href="../../suunnittelu/aiheet/Taloyhtion_palvelut.html">Taloyhtiön palvelut</a></li>
<li><a href="../../suunnittelu/aiheet/Tavaranvaihto.html">Tavaranvaihto</a></li>
<li><a href="../../suunnittelu/aiheet/Tukkuliikkeen_tilaustenksittely.html">Tukkuliikkeen tilaustenkäsittely</a></li>
<li><a href="../../suunnittelu/aiheet/Tutkimusaineston_kerays.html">Tutkimusaineiston keräys</a></li>
<li><a href="../../suunnittelu/aiheet/Tyoaihekanta.html">Työaihekanta</a></li>
<li><a href="../../suunnittelu/aiheet/Tyontekijanvuokraus_kotitoihin.html">Työntekijänvuokraus kotitöihin</a></li>
<li><a href="../../suunnittelu/aiheet/Tyryhmtiedotus.html">Työryhmätiedotus</a></li>
<li><a href="../../suunnittelu/aiheet/Opintoneuvonnan_usein_kysytyt_kysymykset.html">Usein kysytyt kysymykset</a></li>
<li><a href="../../suunnittelu/aiheet/Vedonlyonti.html">Vedonlyönti</a></li>
<li><a href="../../suunnittelu/aiheet/Vuokra-asuntojen_valitys.html">Vuokra-asuntojen välitys</a></li>
<li><a href="../../suunnittelu/aiheet/Ystavanvalityspalvelu.html">Ystävänvälityspalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Aanestys.html">Äänestys</a></li>
</ul></li>
<li><a href="../../suunnittelu/ohjelmointikielet.html">Ohjelmointikielen valinta</a></li>
<li><a href="../../suunnittelu/tietokannan-valinta.html">Tietokannan valinta</a></li>
<li><a href="../../suunnittelu/kayttoliittyma.html">Käyttöliittymän suunnittelu</a></li>
<li><a href="../../suunnittelu/tietokanta.html">Tietokannan suunnittelu</a></li>
</ul></li>
<li><a href="../../pystytys/index.html">Users-palvelin ja töiden pystyttäminen</a>
<ul>
<li><a href="../../pystytys/kayttoonotto/index.html">Palvelujen käynnistäminen ja käyttöönotto</a>
<ul>
<li><a href="../../pystytys/kayttoonotto/java.html">Java ja Tomcatin käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/mysql.html">MySql-tietokannan käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/php.html">PHP-tuen käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/postgresql.html">PostgreSQL-tietokannan käyttöönotto</a></li>
</ul></li>
<li><a href="../../pystytys/netbeans/index.html">NetBeansin käyttöönotto</a>
<ul>
<li><a href="../../pystytys/netbeans/java.html">NetBeansin käyttö Javan kanssa</a></li>
<li><a href="../../pystytys/netbeans/php.html">NetBeansin käyttö PHP:n kanssa</a></li>
<li><a href="../../pystytys/netbeans/keyring-reset.html">Unlock your keyring? - Avainnippujen nollaus</a></li>
</ul></li>
<li><a href="../../pystytys/postgres-ssh-tunneli.html">PostgreSql-kannan etäkäyttö</a></li>
<li><a href="../../pystytys/java-war-paketit.html">Kotikoneella tehdyn Java-työn julkaisu</a></li>
<li><a href="../../pystytys/php-virheet.html">PHP:n virheilmoitusten katselu</a></li>
<li><a href="../../pystytys/nautilus-ssh.html">Tiedostojen etämuokkaus Linuxilla</a></li>
</ul></li>
<li><a href="../../koodaaminen/index.html">Ohjelmointiohjeistus</a>
<ul>
<li><a href="../../koodaaminen/html-opas.html">HTML-opas</a></li>
<li><a href="../../koodaaminen/kannan-alustus.html">Tietokantataulujen pystyttäminen</a></li>
<li><a href="../../koodaaminen/testisovellus.html">ConnectionTest-testisovellus</a></li>
<li class="selected"><a href="../../koodaaminen/tietokantayhteys/index.html">Tietokantayhteyden pystytys</a></li>
<li><a href="../../koodaaminen/git-ja-salasanat.html">Git-repositoriot ja salasanat</a></li>
<li><a href="../../koodaaminen/listaustesti/index.html">Yksinkertainen tietokantalistaus</a>
<ul>
<li><a href="../../koodaaminen/listaustesti/java.html">Listaus Javalla</a></li>
<li><a href="../../koodaaminen/listaustesti/php.html">Listaus PHP:llä</a></li>
</ul></li>
<li><a href="../../koodaaminen/arkkitehtuuri/index.html">Arkkitehtuuri ja MVC</a>
<ul>
<li><a href="../../koodaaminen/arkkitehtuuri/nyrkkisaannot.html">MVC-mallin nyrkisääntöjä</a></li>
</ul></li>
<li><a href="../../koodaaminen/java/index.html">Java-ohjeet</a>
<ul>
<li><a href="../../koodaaminen/java/rakenne.html">Sovelluksen rakenne ja servletit</a></li>
<li><a href="../../koodaaminen/java/nakymat.html">Näkymien tekeminen ja JSP</a></li>
<li><a href="../../koodaaminen/java/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../koodaaminen/java/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
<li><a href="../../koodaaminen/java/mallit_muokkaustoiminnot.html">Malliluokat ja tiedon muuttaminen</a></li>
<li><a href="../../koodaaminen/java/muokkausnakymat.html">Muokkausnäkymän toteuttaminen</a></li>
</ul></li>
<li><a href="../../koodaaminen/php/index.html">PHP-ohjeet</a>
<ul>
<li><a href="../../koodaaminen/php/rakenne.html">Sovelluksen rakenne ja kontrollerit</a></li>
<li><a href="../../koodaaminen/php/nakymat.html">Näkymien tekeminen</a></li>
<li><a href="../../koodaaminen/php/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../koodaaminen/php/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
<li><a href="../../koodaaminen/php/mallit_muokkaustoiminnot.html">Malliluokat ja tiedon muuttaminen</a></li>
<li><a href="../../koodaaminen/php/muokkausnakymat.html">Muokkausnäkymän toteuttaminen</a></li>
</ul></li>
</ul></li>
<li><a href="../../arvosteluperusteet.html">Arvosteluperusteet</a></li>
<li><a href="../../dokumentaatio-ohje.html">Dokumentaatio-ohje</a></li>
<li><a href="../../cleancode.html">Hyvä ohjelmointityyli</a></li>
<li><a href="../../kaytettavyys.html">Käytettävyys</a></li>
<li><a href="../../sivukartta.html">Sivukartta</a></li>
<li><a href="../../web-sovelluksista.html">Web-sovelluksien toiminta</a></li>
</ul></li>
</ul>
</nav>
</div>
<div class="col-md-6" id="content">
<header>
<h1 class="title">Tietokantayhteyden pystytys</h1>
</header>
<!-- order: 3 -->

<section class="alert alert-info"><h3>
Tiivistelmä:
</h3>
<ul>
<li>Varmista että aikaisemmin kirjoittamasi SQL-lauseet toimivat siten tietokantataulusi ovat nyt pystyssä kannassa.</li>
<li>Tietokantayhteyden luonti.
<ul>
<li>Luominen pitää sijoittaa omaan metodiinsa, josta muut tiedostot sitä käyttävät.</li>
<li>Java-kielen NetBeans-ohjeita käyttäneille tarpeen on myös: <a href="../../pystytys/postgres-ssh-tunneli.html">PostgreSQL-ssh-tunnelin luonti</a>. Sama pätee kaikkiin projekteihin, joissa käytetään users:in tietokantaa etänä.</li>
<li>Tietokantaa kannattaa tässä vaiheessa testata jollain hyvin yksinkertaisella testikoodilla.</li>
</ul></li>
<li>Javalla tietokantayhteydet pitää vielä sulkea aineistopyynnön käsittelyn lopuksi. Tätä varten kannattaa tehdä oma metodi.</li>
<li>Jos käytät tietokantayhteyden autentikointiin salasanaa, <a href="../git-ja-salasanat.html#salasanojen-tallentaminen-ja-github">älä laita sitä GitHubiin sellaisenaan</a>.</li>
</ul>
</section>

<p>Seuraavaksi pyrimme luomaan tiedoston, jossa on tarvittava koodi, tietokantayhteyden luomiseen. Samoin esitetään lyhyet testiohjelma, jolla yhteyttä voi testata.</p>
<p>Sekä Javalla että PHP:llä tietokantayhteyksiä edustaa erillinen luokka, jonka olio muodostetaan kutsumalla sopivaa metodia/konstruktoria. Kummallekin annetaan merkkijonona tietokantayhteyttä kuvaava osoite, jonka perusteella yhteys muodostetaan.</p>
<section class="alert alert-danger"><h3>
Pidä mielessä!
</h3>
<p>Viimeistään tässä vaiheessa kannattaa varmistaa, että kirjoittamasi SQL-tiedostot saa ajettua tietokantaan virheettä.</p>
</section>

<p>Alla esimerkit tietokantayhteyden muodostamisesta Javalla ja PHP:llä tilanteessa, jossa tietokantapalvelin on samalla koneella eli osoitteessa <code>localhost</code>. Mikäli tietokantapalvelin on toisella tietokoneella, laita <code>localhost</code>:in tilalle koneen osoite.</p>
<p>Users.cs.helsinki.fi-palvelimen kanssa tämä ei tosin valitettavasti onnistu, sillä tietokantapalvelin on palomuurin takana. Joudut tällöin käyttämään <a href="../../pystytys/postgres-ssh-tunneli.html">ssh-tunnelia</a></p>
<p>Tämä pätee lähinnä niihin jotka ovat noudattaneet kurssin NetBeans-ohjetta Java-kielellä. Jos olet tehnyt näin, tutustu <a href="../../pystytys/postgres-ssh-tunneli.html">ssh-tunnelin</a> muodostamiseen nyt. Et saa kantaan yhteyttä ilman sitä (ellet asenna omaa palvelinta).</p>
<section class="alert alert-danger"><h3>
Pidä mielessä!
</h3>
<p>Joudut useimmiten syöttämään johonkin tiedostoon tietokantatunnustesi salasanan, että saat koodin toimimaan.</p>
<p>Näitä salasanoja ei kuitenkaan kannata laittaa repositorioon sellaisenaan. Hyvä tapa ratkaista ongelma on <a href="../git-ja-salasanat.html">käyttää nk. dist-tiedostoja</a></p>
</section>

<ul class='nav nav-tabs nav-justified'><li class='active'>
<a href='#tab_1_0' data-toggle='tab'>Java, JDBC ja context.xml</a>
</li>
<li>
<a href='#tab_1_1' data-toggle='tab'>PHP ja PDO</a>
</li></ul><div class='panel panel-default'><div class='panel-body'><div class='tab-content'>
<section class='tab-pane active' id='tab_1_0' >

<p>Javalla suosittu tapa tietokantayhteyksien avaamiseen on käyttää DataSource-tyyppistä tietokantayhteysvarastoa, joka huolehtii koko sovelluksen yhteyksien ylläpidosta ja kierrättämisestä eri aineistopyyntöjen välillä.</p>
<p>Ensiksi pitää kuitenkin määritellä Java-koodin rinnalle context.xml-tiedostoon tietokantayhteyttä kuvaava resurssi.</p>
<p><strong>web/META-INF/context.xml</strong></p>
<pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;?xml</span> version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;<span class="kw">?&gt;</span>
<span class="kw">&lt;Context</span><span class="ot"> antiJARLocking=</span><span class="st">&quot;true&quot;</span><span class="ot"> path=</span><span class="st">&quot;/Kissalista-java&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;Resource</span><span class="ot"> name=</span><span class="st">&quot;jdbc/tietokanta&quot;</span><span class="ot"> auth=</span><span class="st">&quot;Container&quot;</span>
<span class="ot">        type=</span><span class="st">&quot;javax.sql.DataSource&quot;</span><span class="ot"> removeAbandoned=</span><span class="st">&quot;true&quot;</span>
<span class="ot">        removeAbandonedTimeout=</span><span class="st">&quot;30&quot;</span><span class="ot"> maxActive=</span><span class="st">&quot;100&quot;</span>
<span class="ot">        maxIdle=</span><span class="st">&quot;30&quot;</span><span class="ot"> maxWait=</span><span class="st">&quot;10000&quot;</span><span class="ot"> username=</span><span class="st">&quot;tunnus&quot;</span>
<span class="ot">        password=</span><span class="st">&quot;salasana&quot;</span>
<span class="ot">        driverClassName=</span><span class="st">&quot;org.postgresql.Driver&quot;</span>
<span class="ot">        url=</span><span class="st">&quot;jdbc:postgresql://localhost/tietokannan_nimi&quot;</span> <span class="kw">/&gt;</span>
<span class="kw">&lt;/Context&gt;</span></code></pre>
<p>Kun resurssi on määritelty, voidaan Javan kirjastoilla hakea se:</p>
<p><strong>Yhteysvaraston pystytyskoodi</strong></p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//Haetaan context-xml-tiedostosta tietokannan yhteystiedot</span>
<span class="co">//HUOM! Tämä esimerkki ei toimi sellaisenaan ilman Tomcat-palvelinta!</span>
InitialContext cxt = <span class="kw">new</span> InitialContext();
DataSource yhteysVarasto = (DataSource) cxt.<span class="fu">lookup</span>(<span class="st">&quot;java:/comp/env/jdbc/tietokanta&quot;</span>);</code></pre>
<button type='button' class='btn-link expandable collapsed' data-toggle='collapse' data-target='#expandable_1'>
Yllä olevan koodin vaatimat importit
</button>
  <div id='expandable_1' class='collapse'><section>

<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">import java.sql.Connection;</span>
<span class="kw">import java.sql.SQLException;</span>
<span class="kw">import javax.naming.Context;</span>
<span class="kw">import javax.naming.InitialContext;</span>
<span class="kw">import javax.naming.NamingException;</span>
<span class="kw">import javax.sql.DataSource;</span></code></pre>
</section></div>

<p>Kun yhteysvarasto on kerran luotu, saa siltä uusia yhteyksiä suorittamalla getConnection-metodin:</p>
<pre class="sourceCode java"><code class="sourceCode java">Connection yhteys = yhteysVarasto.<span class="fu">getConnection</span>(); </code></pre>
<p>Menetelmän etuna on, ettei yhteyksien avaamisia tarvitse erikseen hallinnoida, vaan varasto avaa niitä lisää sitä mukaa kun tarvetta on.</p>
<p>Kun olet suorittanut haluamasi SQL-kyselyn, yhteys pitää sulkea, jolloin se palaa takaisiin varastoon käytettäväksi:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">try</span> { yhteys.<span class="fu">close</span>(); } <span class="kw">catch</span> (Exception e) {  }</code></pre>
<p>Itse varasto-oliota ei tarvitse erikseen sulkea, sillä Tomcat huolehtii sen hallinnoinnista.</p>
<h2>Java ja tietokanta-ajurin lisääminen</h2>
<p>Java-koodarit huomio! Joudut todennäköisimmin tässä vaiheessa lisäämään projektiisi PostgreSQL-kannan ajurikirjaston. NetBeansia käyttäessäsi tämä hoituu samasta kohtaa, kuin JSTL-kirjaston lisääminen: avaa valikosta <code>File-&gt;Project Properties</code>, paina <em>Libraries</em>-kategoriassa nappia <em>Add Library</em> ja lisää listasta projektiin kirjasto nimeltä <code>PostgreSQL JDBC Driver</code>.</p>
<figure>
<img src="../../images/koodaaminen/tietokantayhteys/postgres-ajuri.png" alt="PostgreSQL-ajurin asennus" /><figcaption>PostgreSQL-ajurin asennus</figcaption>
</figure>
<p>Samanlaiset huomiot koskevat MySQL-tietokantaa.</p>
</section>
<section class='tab-pane' id='tab_1_1' >

<p>Yhteyden avaaminen:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="co">//Yleinen muoto</span>
<span class="kw">$tunnus</span> = <span class="st">&quot;kayttajatunnuksesi&quot;</span><span class="ot">;</span>
<span class="kw">$salasana</span>= <span class="st">&quot;psql-salasana&quot;</span><span class="ot">;</span>
<span class="kw">$yhteys</span> = <span class="kw">new</span> <span class="kw">PDO</span><span class="ot">(</span><span class="st">&quot;pgsql:host=localhost;port=5432;dbname=</span><span class="kw">$tunnus</span><span class="st">&quot;</span><span class="ot">,</span> <span class="kw">$tunnus</span><span class="ot">,</span> <span class="kw">$salasana</span><span class="ot">);</span>
<span class="co">//Seuravaa komento pyytää PDO:ta tuottamaan poikkeuksen aina kun jossain on virhe.</span>
<span class="co">//Kannattaa käyttää, oletuksena luokka ei raportoi virhetiloja juuri mitenkään!</span>
<span class="kw">$yhteys</span>-&gt;setAttribute<span class="ot">(</span><span class="kw">PDO</span>::<span class="kw">ATTR_ERRMODE</span><span class="ot">,</span><span class="kw">PDO</span>::<span class="kw">ERRMODE_EXCEPTION</span><span class="ot">);</span></code></pre>
<p>Koodatessa PostgreSQL:llä users-palvelimella voidaan käyttää myös lyhyempää yhteysosoitetta:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="co">//Lyhyempi muoto, joka mm. toimii usersin sisällä</span>
<span class="kw">$yhteys</span> = <span class="kw">new</span> <span class="kw">PDO</span><span class="ot">(</span><span class="st">&quot;pgsql:&quot;</span><span class="ot">);</span>
<span class="kw">$yhteys</span>-&gt;setAttribute<span class="ot">(</span><span class="kw">PDO</span>::<span class="kw">ATTR_ERRMODE</span><span class="ot">,</span><span class="kw">PDO</span>::<span class="kw">ERRMODE_EXCEPTION</span><span class="ot">);</span></code></pre>
</section>
</div></div></div>

<p>Tee itsellesi testiluokka/tiedosto, johon sijoitat sellaisenaan tietokannan muodostamisen. Laita tämä tiedosto omaan pakettiinsa ja/tai kansioonsa. Hyviä nimiä paketille/hakemistolle voivat olla esim. “Tietokanta” tai “Models”. Sovelluksesta tulee huomattavasti selkeämpi, jos kaikki tietokantaa käsittelevä koodi on sijoitettu yhteen paikkaan.</p>
<p>Koeta käynnistää tiedostosi koodi selaimella ja katso muodostuuko yhteys virheittä. Tietokannan nopeaan testaamisen voi myös käyttää seuraavanlaista koodia:</p>
<div class="row">
<div class="col-md-6">
<p><strong>Java</strong></p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//HttpServlet-luokan perivään servlettiin menevä metodi:</span>
<span class="kw">protected</span> <span class="dt">void</span> <span class="fu">processRequest</span>(HttpServletRequest request, HttpServletResponse response)
      <span class="kw">throws</span> ServletException, IOException {
  Connection yhteys = Tietokanta.<span class="fu">getYhteys</span>(); <span class="co">//Haetaan tietokantaluokalta yhteysolio</span>
  PreparedStatement kysely;
  ResultSet tulokset;
  PrintWriter out = response.<span class="fu">getWriter</span>(); 
  response.<span class="fu">setContentType</span>(<span class="st">&quot;text/plain;charset=UTF-8&quot;</span>);

  <span class="kw">try</span> {
    String sql = <span class="st">&quot;SELECT 1+1 as two&quot;</span>;
    kysely = yhteys.<span class="fu">prepareStatement</span>(sql);
    tulokset = kysely.<span class="fu">executeQuery</span>();
    <span class="kw">if</span>(tulokset.<span class="fu">next</span>()) {
      <span class="dt">int</span> kakkonen = tulokset.<span class="fu">getInt</span>(<span class="st">&quot;two&quot;</span>);
      out.<span class="fu">println</span>(<span class="st">&quot;Tulos: &quot;</span>+kakkonen<span class="st">&quot;); </span>
    } <span class="kw">else</span> {
      out.<span class="fu">println</span>(<span class="st">&quot;Virhe!&quot;</span>); 
    }
  } <span class="kw">catch</span> (Exception e) {
    out.<span class="fu">println</span>(<span class="st">&quot;Virhe: &quot;</span>+e.<span class="fu">getMessage</span>()<span class="st">&quot;); </span>
  }

  tulokset.<span class="fu">close</span>(); kysely.<span class="fu">close</span>();
}</code></pre>
<p>Sijoita tämä koodi asianmukaisen servletin processRequest-metodiin. Koodin pitäisi lähettää selaimelle teksti “Tulos: 2”.</p>
</div>
<div class="col-md-6">
<p><strong>PHP</strong></p>
<pre class="sourceCode php"><code class="sourceCode php">


<span class="kw">$sql</span> = <span class="st">&quot;select 1+1 as two&quot;</span><span class="ot">;</span>
<span class="kw">$kysely</span> = <span class="kw">$yhteys</span>-&gt;prepare<span class="ot">(</span><span class="kw">$sql</span><span class="ot">);</span>


<span class="kw">if</span> <span class="ot">(</span><span class="kw">$kysely</span>-&gt;execute<span class="ot">())</span> {
  <span class="kw">$kakkonen</span> = <span class="kw">$kysely</span>-&gt;fetchColumn<span class="ot">();</span>
  <span class="fu">var_dump</span><span class="ot">(</span><span class="kw">$kakkonen</span><span class="ot">);</span>
}</code></pre>
<p>Koodin pitäisi tulostaa seuraava teksti debug-koodaukseen tarkoitettua <a href="http://php.net/manual/en/function.var-dump.php">var_dump</a>-funktiota käyttäen:</p>
<pre><code>int(2)</code></pre>
</div>
</div>

<p>Kun olet saanut saanut yhteyden toimimaan ja palauttamaan kannasta tietoa, laita se omaan metodiinsa, joka palauttaa yhteyden. Voit tehdä yhteydelle halutessasi myös oman luokan, johon sijoitat muitakin toistuvia tietokantaan liittyviä koodinpäktiä.</p>
<p>Jos et halua tehdä luokkaa, voit PHP:llä käyttää myös lyhyttä funktiota, jossa on funktion sisäinen <a href="http://php.net/manual/en/language.variables.scope.php#language.variables.scope.static">staattinen muuttuja</a>:</p>
<pre class="sourceCode php"><code class="sourceCode php"><span class="kw">function</span> annaYhteys<span class="ot">()</span> {
  <span class="kw">static</span> <span class="kw">$yhteys</span> = <span class="kw">null</span><span class="ot">;</span> <span class="co">//Muuttuja, jonka sisältö säilyy annaYhteys-kutsujen välillä.</span>

  <span class="kw">if</span> <span class="ot">(</span><span class="kw">$yhteys</span> === <span class="kw">null</span><span class="ot">)</span> { 
    <span class="co">//Tämä koodi suoritetaan vain kerran, sillä seuraavilla </span>
    <span class="co">//funktion suorituskerroilla $yhteys-muuttujassa on sisältöä.</span>
    <span class="kw">$yhteys</span> = <span class="kw">new</span> <span class="kw">PDO</span><span class="ot">(</span><span class="st">&#39;pgsql:&#39;</span><span class="ot">);</span>
    <span class="kw">$yhteys</span>-&gt;setAttribute<span class="ot">(</span><span class="kw">PDO</span>::<span class="kw">ATTR_ERRMODE</span><span class="ot">,</span><span class="kw">PDO</span>::<span class="kw">ERRMODE_EXCEPTION</span><span class="ot">);</span>
  }

  <span class="kw">return</span> <span class="kw">$yhteys</span><span class="ot">;</span>
}

<span class="co">//Funktiota voi käyttää näin</span>
<span class="kw">$kysely</span> = annaYhteys<span class="ot">()</span>-&gt;prepare<span class="ot">(</span><span class="st">&quot;SELECT 1&quot;</span><span class="ot">);</span></code></pre>
<p>PHP:llä koodatessa on tärkeää, että yhteys luodaan vain kerran, sillä sen luominen on verraten hidasta. Javalla Tomcat huolehtii tästä, mutta yhteys pitää erikseen sulkea. Javaa käyttäessä sinun kannattaa siis tehdä myös apumetodi, joka sulkee yhteyden.</p>
<section class="alert alert-success small"><h3>
Seuraavaksi:
</h3>
<p>Kun olet saanut tietokantaan toimivan yhteyden ja laittanut sen omaan tiedostoonsa, voit jatkaa tietokantaohjelmointia tekemällä <a href="../listaustesti/index.html">yksinkertaisen listauksen</a>.</p>
</section>



</div>
</div> 
</div> 
<footer>
  <a href="../../sivukartta.html">Sivukartta</a> - 
  <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">AdvancedKittenry</span> 
  by
  <a xmlns:cc="http://creativecommons.org/ns#" href="http://advancedkittenry.github.io/credits.html" property="cc:attributionName" rel="cc:attributionURL">David Consuegra and others</a>
  is licensed under a 
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" />
  </a>
</footer>
</body>
</html>
