<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title>Tietojen syöttäminen kantaan</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="../../css/base.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <script src="../../javascript/jquery.min.js"></script>
  <script src="../../javascript/bootstrap.js"></script>
  <script src="../../javascript/jquery.treeview.js"></script>
  <script src="../../javascript/jquery.scrollTo.js"></script>
  <script src="../../javascript/jquery.nav.js"></script>
  <script src="../../javascript/navi.js"></script>
</head>
<body>
<div class="titlebar">
  <div class="container">
    <div class="row">
      <h1 class="col-md-6 col-md-offset-3">Advanced Kittenry - Tietokantasovellusohjeet</h1>
    </div>
  </div>
</div>
<div class="container">
<div class="row">
<div class="navcontainer col-md-3">
<nav>
<ul>
<li><a href="../../index.html">Tietokantasovellus</a>
<ul>
<li><a href="../../aikataulu/index.html">Aikataulu</a>
<ul>
<li><a href="../../aikataulu/viikkopalautukset/index.html">Viikottaiset palautukset</a>
<ul>
<li><a href="../../aikataulu/viikkopalautukset/esittelysivu.html">Työn esittelysivu</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko1.html">Viikko 1</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko2.html">Viikko 2</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko3.html">Viikko 3</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko4.html">Viikko 4</a></li>
<li><a href="../../aikataulu/viikkopalautukset/viikko5.html">Viikko 5</a></li>
</ul></li>
<li><a href="../../aikataulu/koodikatselmointi.html">Koodikatselmointi</a></li>
<li><a href="../../aikataulu/demo.html">Demotilaisuus</a></li>
<li><a href="../../aikataulu/palautus.html">Työn palautus</a></li>
</ul></li>
<li><a href="../../suunnittelu/index.html">Työn suunnittelu</a>
<ul>
<li><a href="../../suunnittelu/aiheet/index.html">Työaiheet</a>
<ul>
<li><a href="../../suunnittelu/aiheet/Drinkkiarkisto.html">Drinkkiarkisto</a></li>
<li><a href="../../suunnittelu/aiheet/Elektroninen_keittokirja.html">Elektroninen keittokirja</a></li>
<li><a href="../../suunnittelu/aiheet/Graduaiheet.html">Graduaiheet</a></li>
<li><a href="../../suunnittelu/aiheet/Hiihtokisojen_tulospalvelu.html">Hiihtokisojen tulospalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Huutokauppa.html">Huutokauppa</a></li>
<li><a href="../../suunnittelu/aiheet/Kennelkerho.html">Kennelkerho</a></li>
<li><a href="../../suunnittelu/aiheet/Keskustelufoorumi.html">Keskustelufoorumi</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssikysely.html">Kurssikysely</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssin_kotisivu.html">Kurssin kotisivu</a></li>
<li><a href="../../suunnittelu/aiheet/Kurssitarjonta_ja_kurssipaikan_varaus.html">Kurssitarjonta ja kurssipaikan varaus</a></li>
<li><a href="../../suunnittelu/aiheet/Laakariaseman_tyovuorolista.html">Lääkäriaseman työvuorolista</a></li>
<li><a href="../../suunnittelu/aiheet/Laakarin_kotikaynnit.html">Lääkärin kotikäynnit</a></li>
<li><a href="../../suunnittelu/aiheet/Matkojen_markkinointi.html">Matkojen markkinointi</a></li>
<li><a href="../../suunnittelu/aiheet/Muistilista.html">Muistilista</a></li>
<li><a href="../../suunnittelu/aiheet/Ostoskassi.html">Ostoskassi</a></li>
<li><a href="../../suunnittelu/aiheet/Palvelubisnes.html">Palvelubisnes</a></li>
<li><a href="../../suunnittelu/aiheet/Parturi-Kampaamo.html">Parturi-Kampaamo</a></li>
<li><a href="../../suunnittelu/aiheet/Pizzapalvelu.html">Pizzapalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Pokemon-kanta.html">Pokémon-tietokanta</a></li>
<li><a href="../../suunnittelu/aiheet/Projektin_tyoaikaseuranta.html">Projektin työaikaseuranta</a></li>
<li><a href="../../suunnittelu/aiheet/Rankkauslista.html">Rankkauslista</a></li>
<li><a href="../../suunnittelu/aiheet/Taloyhtion_palvelut.html">Taloyhtiön palvelut</a></li>
<li><a href="../../suunnittelu/aiheet/Tavaranvaihto.html">Tavaranvaihto</a></li>
<li><a href="../../suunnittelu/aiheet/Tukkuliikkeen_tilaustenksittely.html">Tukkuliikkeen tilaustenkäsittely</a></li>
<li><a href="../../suunnittelu/aiheet/Tutkimusaineston_kerays.html">Tutkimusaineiston keräys</a></li>
<li><a href="../../suunnittelu/aiheet/Tyoaihekanta.html">Työaihekanta</a></li>
<li><a href="../../suunnittelu/aiheet/Opintoneuvonnan_usein_kysytyt_kysymykset.html">Usein kysytyt kysymykset</a></li>
<li><a href="../../suunnittelu/aiheet/Vedonlyonti.html">Vedonlyönti</a></li>
<li><a href="../../suunnittelu/aiheet/Vuokra-asuntojen_valitys.html">Vuokra-asuntojen välitys</a></li>
<li><a href="../../suunnittelu/aiheet/Ystavanvalityspalvelu.html">Ystävänvälityspalvelu</a></li>
<li><a href="../../suunnittelu/aiheet/Aanestys.html">Äänestys</a></li>
</ul></li>
<li><a href="../../suunnittelu/ohjelmointikielet.html">Ohjelmointikielen valinta</a></li>
<li><a href="../../suunnittelu/tietokannan-valinta.html">Tietokannan valinta</a></li>
<li><a href="../../suunnittelu/kayttoliittyma.html">Käyttöliittymän suunnittelu</a></li>
<li><a href="../../suunnittelu/tietokanta.html">Tietokannan suunnittelu</a></li>
</ul></li>
<li><a href="../../pystytys/index.html">Users-palvelin ja töiden pystyttäminen</a>
<ul>
<li><a href="../../pystytys/kayttoonotto/index.html">Palvelujen käynnistäminen ja käyttöönotto</a>
<ul>
<li><a href="../../pystytys/kayttoonotto/java.html">Java ja Tomcatin käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/mysql.html">MySql-tietokannan käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/php.html">PHP-tuen käyttöönotto</a></li>
<li><a href="../../pystytys/kayttoonotto/postgresql.html">PostgreSQL-tietokannan käyttöönotto</a></li>
</ul></li>
<li><a href="../../pystytys/netbeans/index.html">NetBeansin käyttöönotto</a>
<ul>
<li><a href="../../pystytys/netbeans/java.html">NetBeansin käyttö Javan kanssa</a></li>
<li><a href="../../pystytys/netbeans/php.html">NetBeansin käyttö PHP:n kanssa</a></li>
<li><a href="../../pystytys/netbeans/keyring-reset.html">Unlock your keyring? - Avainnippujen nollaus</a></li>
</ul></li>
<li><a href="../../pystytys/postgres-ssh-tunneli.html">PostgreSql-kannan etäkäyttö</a></li>
<li><a href="../../pystytys/java-war-paketit.html">Kotikoneella tehdyn Java-työn julkaisu</a></li>
<li><a href="../../pystytys/php-virheet.html">PHP:n virheilmoitusten katselu</a></li>
<li><a href="../../pystytys/nautilus-ssh.html">Tiedostojen etämuokkaus Linuxilla</a></li>
</ul></li>
<li><a href="../../koodaaminen/index.html">Ohjelmointiohjeistus</a>
<ul>
<li><a href="../../koodaaminen/html-opas.html">HTML-opas</a></li>
<li><a href="../../koodaaminen/kannan-alustus.html">Tietokantataulujen pystyttäminen</a></li>
<li><a href="../../koodaaminen/testisovellus.html">ConnectionTest-testisovellus</a></li>
<li><a href="../../koodaaminen/git-ja-salasanat.html">Git-repositoriot ja salasanat</a></li>
<li><a href="../../koodaaminen/arkkitehtuuri/index.html">Arkkitehtuuri ja MVC</a>
<ul>
<li><a href="../../koodaaminen/arkkitehtuuri/nyrkkisaannot.html">MVC-mallin nyrkisääntöjä</a></li>
</ul></li>
<li><a href="../../koodaaminen/java/index.html">Java-ohjeet</a>
<ul>
<li><a href="../../koodaaminen/java/tietokantayhteys.html">Tietokantayhteyden pystytys</a></li>
<li><a href="../../koodaaminen/java/listaustesti.html">Listaustesti</a></li>
<li><a href="../../koodaaminen/java/rakenne.html">Sovelluksen rakenne ja servletit</a></li>
<li><a href="../../koodaaminen/java/nakymat.html">Näkymien tekeminen ja JSP</a></li>
<li><a href="../../koodaaminen/java/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../koodaaminen/java/mallit_tiedonhaku.html">Tietokantahaku ja kyselyn parametrit</a></li>
<li><a href="../../koodaaminen/java/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
<li><a href="../../koodaaminen/java/listausnakymat.html">Listaus- ja tietonäkymät</a></li>
<li><a href="../../koodaaminen/java/sivutusjahaut.html">Sivutus ja hakulomakkeet</a></li>
<li class="selected"><a href="../../koodaaminen/java/mallit_lisays.html">Tietojen syöttäminen kantaan</a></li>
<li><a href="../../koodaaminen/java/muokkausnakymat.html">Muokkausnäkymän toteuttaminen</a></li>
</ul></li>
<li><a href="../../koodaaminen/php/index.html">PHP-ohjeet</a>
<ul>
<li><a href="../../koodaaminen/php/tietokantayhteys.html">Tietokantayhteyden pystytys</a></li>
<li><a href="../../koodaaminen/php/listaustesti.html">Listaustesti</a></li>
<li><a href="../../koodaaminen/php/rakenne.html">Sovelluksen rakenne ja kontrollerit</a></li>
<li><a href="../../koodaaminen/php/nakymat.html">Näkymien tekeminen</a></li>
<li><a href="../../koodaaminen/php/lomakkeet.html">Lomakkeiden käyttö ja vastaanottaminen</a></li>
<li><a href="../../koodaaminen/php/mallit_tiedonhaku.html">Tietokantahaku ja kyselyn parametrit</a></li>
<li><a href="../../koodaaminen/php/istunnot.html">Istunnot ja kirjautumisen tallentaminen</a></li>
<li><a href="../../koodaaminen/php/listausnakymat.html">Listaus- ja tietonäkymät</a></li>
<li><a href="../../koodaaminen/php/sivutusjahaut.html">Sivutus ja hakulomakkeet</a></li>
<li><a href="../../koodaaminen/php/mallit_lisays.html">Tietojen syöttäminen kantaan</a></li>
<li><a href="../../koodaaminen/php/muokkausnakymat.html">Muokkausnäkymän toteuttaminen</a></li>
</ul></li>
</ul></li>
<li><a href="../../arvosteluperusteet.html">Arvosteluperusteet</a></li>
<li><a href="../../dokumentaatio-ohje.html">Dokumentaatio-ohje</a></li>
<li><a href="../../cleancode.html">Hyvä ohjelmointityyli</a></li>
<li><a href="../../kaytettavyys.html">Käytettävyys</a></li>
<li><a href="../../sivukartta.html">Sivukartta</a></li>
<li><a href="../../web-sovelluksista.html">Web-sovelluksien toiminta</a></li>
</ul></li>
</ul>
</nav>
</div>
<div class="col-md-6" id="content">
<header>
<h1 class="title">Tietojen syöttäminen kantaan</h1>
</header>
<!-- order: 9 -->

<section class="alert alert-info"><h3>
Tiivistelmä:
</h3>
<ul>
<li>Malliluokan oliolla kannattaa olla metodi, jolla se osaa syöttää itsensä kantaan (INSERT-lause), sekä metodit, joilla tarkistetaan ovatko syötettävät arvot oikeanlaisia.</li>
<li>Lomakkeen kontrolleri ohjaa takaisin esitäytetylle lomakesivulle, mikäli lomake on virheellisesti täytetty.
<ul>
<li>Tiedot voidaan näyttää antamalla lomakkeelle näytettäväksi malliluokan olio, johon on asetettu käyttäjän syöttämät lomaketiedot.</li>
<li>Väärin syötetyt tiedot eritellään virheilmoituksin.</li>
</ul></li>
<li>Sekä lomakkeita, että sivunäkymiä näytettäessä kannattaa varmistaa, etteivät käyttäjän syöttämät HTML-koodinpätkät, lainausmerkit yms. sotke sivujen rakennetta.
<ul>
<li>Javassa voi käyttää <a href="http://docs.oracle.com/javaee/5/jstl/1.1/docs/tlddocs/">out-tägiä</a>: <code>&lt;c:out value=&quot;${muuttuja}&quot;/&gt;</code></li>
</ul></li>
<li>Jos lomakkeessa käsitellään viiteavaimia, käytä <a href="#selecttag">SELECT-tägiä</a></li>
<li>Lomake ohjaa lisäyksen onnistuessa selaimen listaussivulle.</li>
<li>Onnistumisesta onnistumisviesti</li>
<li>Viesti kannattaa välittää <a href="#sessionmessages">istunnossa</a></li>
</ul>
</section>

<section id="tietojen-syöttäminen-malliluokan-olioon" class="level2">
<h2>Tietojen syöttäminen malliluokan olioon</h2>
<p>Paras tapa toteuttaa jonkin tietokohteen olion, esimerkiksi kissan, syöttäminen tietokantaan, on tehdä siitä oliopohjaista: Ensiksi luodaan kissaolio, jonka jälkeen asetetaan sille settereillä sopivat arvot.</p>
<p><strong>Esimerkki lisäyskontrollerin alusta</strong></p>
<pre class="sourceCode java"><code class="sourceCode java">Kissa uusikatti = <span class="kw">new</span> <span class="fu">Kissa</span>();
uusikatti.<span class="fu">setNimi</span>(request.<span class="fu">getParameter</span>(<span class="st">&quot;nimi&quot;</span>));
uusikatti.<span class="fu">setVari</span>(request.<span class="fu">getParameter</span>(<span class="st">&quot;vari&quot;</span>));
uusikatti.<span class="fu">setRotuId</span>(request.<span class="fu">getParameter</span>(<span class="st">&quot;rotu_id&quot;</span>));</code></pre>
<section id="olion-syöttäminen-kantaan" class="level3">
<h3>Olion syöttäminen kantaan</h3>
<p>Kun olio on luotu, kutsutaan varta vasten tätä tarkoitusta varten tehtyä metodia, joka lisää olion kantaan. Malliin kannattaa rakentaa seuraavankaltainen <a href="http://www.postgresql.org/docs/8.4/static/sql-insert.html">INSERT-lausetta</a> kutsuva koodinpätkä:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">lisaaKantaan</span>() <span class="kw">throws</span> NamingException, SQLException {
  String sql = <span class="st">&quot;INSERT INTO Kissat(nimi, vari, rotu_id) VALUES(?,?,?) RETURNING id&quot;</span>;
  Connection yhteys = Tietokanta.<span class="fu">getYhteys</span>();
  PreparedStatement kysely = yhteys.<span class="fu">prepareStatement</span>(sql);

  kysely.<span class="fu">setString</span>(<span class="dv">1</span>, <span class="kw">this</span>.<span class="fu">getNimi</span>());
  kysely.<span class="fu">setString</span>(<span class="dv">2</span>, <span class="kw">this</span>.<span class="fu">getVari</span>());
  kysely.<span class="fu">setInt</span>(<span class="dv">3</span>, <span class="kw">this</span>.<span class="fu">getRotuId</span>());

  ResultSet ids = kysely.<span class="fu">executeQuery</span>();
  ids.<span class="fu">next</span>();

  <span class="co">//Haetaan RETURNING-määreen palauttama id.</span>
  <span class="co">//HUOM! Tämä toimii ainoastaan PostgreSQL-kannalla!</span>
  <span class="kw">this</span>.<span class="fu">id</span> = ids.<span class="fu">getInt</span>(<span class="dv">1</span>);

  <span class="kw">try</span> { ids.<span class="fu">close</span>(); } <span class="kw">catch</span> (Exception e) {}
  <span class="kw">try</span> { kysely.<span class="fu">close</span>(); } <span class="kw">catch</span> (Exception e) {}
  <span class="kw">try</span> { yhteys.<span class="fu">close</span>(); } <span class="kw">catch</span> (Exception e) {}

}</code></pre>
<p>Huomaa miten <a href="http://www.postgresql.org/docs/9.2/static/datatype-numeric.html#DATATYPE-SERIAL">SERIAL-tyyppistä</a> pääavainta käytettäessä INSERT-lauseeseen ei laiteta id-avaimelle lainkaan arvoa, jolloin kanta laittaa kenttään seuraavan vapaan arvon. Tämän numeroon noutamista varten on olemassa omat kikkansa:</p>
<ul>
<li>PostgreSQL:llä voidaan INSERT-lauseen jälkeen laittaa käsky <code>RETURNING id</code>, jolloin kysely palauttaa kentän <code>id</code> arvon ikään kuin se olisi SELECT-kysely.</li>
<li>MySQL:llä olemassa <a href="http://www.technicalkeeda.com/details/how-to-get-mysql-auto-increment-key-value-using-java-jdbc">oma tekniikkansa</a>.</li>
</ul>
</section>
</section>
<section id="virheiden-tarkistaminen" class="level2">
<h2>Virheiden tarkistaminen</h2>
<p>Yllä esitetyssä koodissa on yksi puute: virheellisiä syötteitä ei tarkisteta mitenkään ja pahimmassa tapauksessa kysely saattaa jopa kaatua, jos kantaan syötetään jotakin, mikä sinne ei kuulu.</p>
<p>Tarvitaan mekanismi, joka tarkistaa ovatko olioon syötetyt tiedot järkeviä. Tiedoista riippuen pitää olio joko syöttää kantaan, tai näyttää käyttäjälle virheilmoituksin varustettu lisäyslomake, jotta käyttäjä voi korjata virheensä.</p>
<p>Selkeä tapa toteuttaa tämä on lisätä malliluokan rajapintaan kaksi metodia, jotka voi nimetä vaikkapa <code>onkoKelvollinen</code> ja <code>getVirheet</code>. Näistä ensimmäinen kertoo, ovatko olioon asetetut tiedot tiedot oikeat ja jälkimmäinen palauttaa kaikki olion tietoihin liittyvät virheet.</p>
<p>Virheentarkistusmetodeja voi sitten kontrollerissa käyttää näin:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="co">//Pyydetään Kissa-oliota tarkastamaan syötetyt tiedot.</span>
<span class="kw">if</span> (uusikatti.<span class="fu">onkoKelvollinen</span>()) {
  uusikatti.<span class="fu">lisaaKantaan</span>();

  <span class="co">//Kissa lisättiin kantaan onnistuneesti, lähetetään käyttäjä eteenpäin</span>
  response.<span class="fu">sendRedirect</span>(<span class="st">&quot;kissalista&quot;</span>);

  <span class="co">//Asetetaan istuntoon ilmoitus siitä, että kissa on lisätty.</span>
  <span class="co">//Tästä tekniikasta kerrotaan lisää kohta</span>
  HttpSession session = request.<span class="fu">getSession</span>();
  session.<span class="fu">setAttribute</span>(<span class="st">&quot;ilmoitus&quot;</span>, <span class="st">&quot;Kissa lisätty onnistuneesti.&quot;</span>);

} <span class="kw">else</span> {
  Collection&lt;String&gt; virheet = uusikatti.<span class="fu">getVirheet</span>();

  request.<span class="fu">setAttribute</span>(<span class="st">&quot;virheet&quot;</span>, virheet);
  request.<span class="fu">setAttribute</span>(<span class="st">&quot;kissa&quot;</span>, uusikatti);
  <span class="fu">naytaJSP</span>(<span class="st">&quot;kissalomake.jsp&quot;</span>, request, response);
}</code></pre>
<p>Virheentarkistusmetodit voi toteuttaa käytännössä kahdella tavalla riippuen siitä missä tarkistuksen haluaa tehdä:</p>
<ol type="1">
<li>Laitetaan tarkistukset suoraan settereihin ja pidetään jatkuvasti yllä tietorakennetta siitä mitkä tiedot ovat kelvollisia.</li>
<li>Laitetaan tarkistukset <code>onkoKelvollinen</code>-metodiin ja tarkistetaan kaikki kentät kerralla.</li>
</ol>
<p>Ensimmäinen toteutustapa on usein selkeämpi, sillä yhtä kenttää koskevat toiminnot pysyvät yhdessä paikassa, mutta jälkimmäisellä tavalla on joskus mahdollista automatisoida toistuvia tarkistuksia hieman paremmin laittamalla toisteista koodia luuppeihin.</p>
<p>Alla esimerkki siitä miten virheentarkistuksen voi toteuttaa settereillä, jotka muokkaavat privaattikentäksi määriteltyä virhetaulukkoa.</p>
<p><strong>Ote kissojen malliluokasta</strong></p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Kissa {
  <span class="kw">private</span> Map&lt;String,String&gt; virheet = <span class="kw">new</span> HashMap&lt;String,String&gt;();

  <span class="kw">public</span> <span class="dt">void</span> <span class="fu">setNimi</span>(String uusinimi) {
    <span class="kw">this</span>.<span class="fu">nimi</span> = uusinimi;

    <span class="kw">if</span> (uusinimi.<span class="fu">trim</span>().<span class="fu">length</span>() == <span class="dv">0</span>) {
      virheet.<span class="fu">put</span>(<span class="st">&quot;nimi&quot;</span>, <span class="st">&quot;Nimi ei saa olla tyhjä.&quot;</span>);
    } <span class="kw">else</span> {
      virheet.<span class="fu">remove</span>(<span class="st">&quot;nimi&quot;</span>);
    }
  }

  ...</code></pre>
<section id="numeerisen-datan-vastaanottaminen" class="level3">
<h3>Numeerisen datan vastaanottaminen</h3>
<p>Kaikki <code>request</code>-oliolta saatu data on merkkijonomuotoista. Numeroiden vastaanottaminen on siksi astetta hankalampaa.</p>
<p>Numeromuotoisille kentille voi olla siksi järkevää tehdä erillinen merkkijonoja vastaanottava setteri, joka käyttää normaalia setteriä hyväkseen:</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">setPituus</span>(<span class="dt">int</span> uusiPituus) {
  <span class="kw">this</span>.<span class="fu">pituus</span> = uusiPituus;

  <span class="kw">if</span> (uusiPituus &lt;= <span class="dv">0</span>) {
    virheet.<span class="fu">put</span>(<span class="st">&quot;pituus&quot;</span>, <span class="st">&quot;Kissalla täytyy olla positiivinen pituus.&quot;</span>);
  } <span class="kw">else</span> {
    virheet.<span class="fu">remove</span>(<span class="st">&quot;pituus&quot;</span>);
  }
}
<span class="kw">public</span> <span class="dt">void</span> <span class="fu">setPituus</span>(String uusipituus) {
  <span class="kw">try</span> {
    <span class="fu">setPituus</span>(Integer.<span class="fu">parseInt</span>(uusiPituus));
  } <span class="kw">catch</span>(NumberFormatException e) {
    virheet.<span class="fu">put</span>(<span class="st">&quot;pituus&quot;</span>, <span class="st">&quot;Kissan pituuden tulee olla kokonaisluku.&quot;</span>);
  }
}</code></pre>
<p>Kentissä, jotka viittaavat toisiin tauluihin, voi olla järkevää tehdä tarkistuksia vielä siitä onko viitattu olento olemassa. Tämän voi helposti tehdä tekemällä viitattuun tauluun sopivan hakumetodin, jolla voi hakea tietueita pääavaimen perusteella:</p>
<pre class="sourceCode java"><code class="sourceCode java">  <span class="co">//Tarkistetaan, että rotu on olemassa</span>
  <span class="kw">if</span> (Kissarotu.<span class="fu">etsi</span>(uusirotu_id) == <span class="kw">null</span>) {
    <span class="kw">this</span>.<span class="fu">virheet</span>.<span class="fu">put</span>(<span class="st">&quot;rotu_id&quot;</span>, <span class="st">&quot;Kissan rotua ei löytynyt tietokannasta&quot;</span>);
  } <span class="kw">else</span> {
    virheet.<span class="fu">remove</span>(<span class="st">&quot;rotu_id&quot;</span>);
  }</code></pre>
<p>Mallien välinen viittailu on myös mahdollista rakentaa siten, että oliolle annnetaan setterissä toisen taulun olioita, joista poimitaan id.</p>
</section>
<section id="virhemetodien-toteutus" class="level3">
<h3>Virhemetodien toteutus</h3>
<p>onkoKelvollinen-metodin toteutukseksi riittää käytetyn virhetaulukon tyhjyyden tarkistava <a href="http://docs.oracle.com/javase/7/docs/api/java/util/HashMap.html#isEmpty()"><code>isEmpty</code>-metodi</a>:</p>
<pre class="sourceCode java"><code class="sourceCode java">  <span class="co">/* Palauttaa true, jos Kissaan syötetyt arvot ovat järkeviä. */</span>
  <span class="kw">public</span> <span class="dt">boolean</span> <span class="fu">onkoKelvollinen</span>() {
    <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">virheet</span>.<span class="fu">isEmpty</span>();
  }</code></pre>
<p>getVirheet taas voi palauttaa virheet-assosiaatiotaulun arvojoukon sellaisenaan:</p>
<pre class="sourceCode java"><code class="sourceCode java">  <span class="kw">public</span> Collection&lt;String&gt; <span class="fu">getVirheet</span>() {
    <span class="kw">return</span> virheet.<span class="fu">values</span>();
  }</code></pre>
</section>
</section>
<section id="käytettävä-lisäyslomake" class="level2">
<h2>Käytettävä lisäyslomake</h2>
<p>Lomakkeen kontrolleri ohjaa aina takaisin lomakesivulle, mikäli lomake on virheellisesti täytetty. Lomakkeessa on tällöin näkyvissä ne tiedot, jotka käyttäjä siihen syötti.</p>
<p>Tämän takia lomake kannatta toteuttaa siten, että sille annetaan aina jokin olio, jonka tietoja lomakkeen input-tägit näyttävät.</p>
<pre class="sourceCode java"><code class="sourceCode java">request.<span class="fu">setAttribute</span>(<span class="st">&quot;kissa&quot;</span>, uusikatti);
<span class="fu">naytaJSP</span>(<span class="st">&quot;kissalomake.jsp&quot;</span>, request, response);</code></pre>
<pre class="sourceCode jsp"><code class="sourceCode jsp">&lt;input<span class="ot"> type</span>=<span class="dt">&quot;text&quot;</span><span class="ot"> class</span>=<span class="dt">&quot;form-control&quot;</span><span class="ot"> name</span>=<span class="dt">&quot;nimi&quot;</span><span class="ot"> placeholder</span>=<span class="dt">&quot;Kissan nimi&quot;</span>
<span class="ot">value</span>=<span class="dt">&quot;</span>${kissa.nimi}<span class="dt">&quot;</span>&gt;</code></pre>
<p>Silloin kun käyttäjä ei ole vielä laittanut lomakkeeseen mitään, ei oliota tarvitse välittää ollenkaan.</p>
<section class="alert alert-info"><h3>
Lisätietoa
</h3>
<p>Jos oliollasi on numerokenttiä, on hyvä välittää niiden <code>value</code>-attribuuttiin suoraan käyttäjältä saatu syöte, jotta käyttäjän mahdollisesti syöttämät kelvottomat numeromerkkijonot näkyvät sellaisenaan. Näin käyttäjän on helpompi korjata ne.</p>
<p>Tämän voi toteuttaa joko omana kenttänään suoraan malliluokassa tai erikseen kontrollerissa.</p>
</section>

<p>Jos käyttäjä taas on syöttänyt tietoja, mutta tiedot eivät ole käypiä, näytetään olio, johon tietoja on koetettu syöttää, sekä samalla olion kelpoisuuden tarkistamisesta saadut virheviestit.</p>
<pre class="sourceCode java"><code class="sourceCode java">Collection&lt;String&gt; virheet = uusikatti.<span class="fu">getVirheet</span>();

request.<span class="fu">setAttribute</span>(<span class="st">&quot;virheet&quot;</span>, virheet);
request.<span class="fu">setAttribute</span>(<span class="st">&quot;kissa&quot;</span>, uusikatti);
<span class="fu">naytaJSP</span>(<span class="st">&quot;kissalomake.jsp&quot;</span>, request, response);</code></pre>
<section id="syötteiden-sanitointi" class="level3">
<h3>Syötteiden sanitointi</h3>
<p>Sekä lomakkeita, että sivunäkymiä näytettäessä kannattaa varmistaa, etteivät käyttäjän syöttämät HTML-koodinpätkät, lainausmerkit yms. sotke sivujen rakennetta.</p>
<p>Tähän ongelmaan autttaa parhaiten JSTL-kirjaston <a href="http://docs.oracle.com/javaee/5/jstl/1.1/docs/tlddocs/">out-tägi</a>:</p>
<pre class="sourceCode jsp"><code class="sourceCode jsp"><span class="kw">&lt;c:out</span><span class="ot"> value</span>=<span class="dt">&quot;</span>${muuttuja}<span class="dt">&quot;</span><span class="kw">/&gt;</span></code></pre>
</section>
<section id="selecttag" class="level3">
<h3>Viiteavaimet lomakkeissa</h3>
<p>Jos muokattavassa oliossa on viite johonkin toiseen tauluun täytyy käyttäjälle näyttää lomakkeessa jonkinlainen valinta eri vaihtoehtojen välillä. Helpoin tapa on käyttää <a href="http://www.w3schools.com/TAGS/tag_select.asp">select-elementin</a> kautta tehtävää pudotusvalikkoa:</p>
<pre class="sourceCode jsp"><code class="sourceCode jsp">&lt;label&gt;Rotu&lt;/label&gt;
&lt;select<span class="ot"> name</span>=<span class="dt">&quot;rotu_id&quot;</span>&gt;
<span class="kw">&lt;c:forEach</span><span class="ot"> var</span>=<span class="dt">&quot;rotu&quot;</span><span class="ot"> items</span>=<span class="dt">&quot;</span>${kissarodut}<span class="dt">&quot;</span><span class="kw">&gt;</span>
  &lt;option<span class="ot"> value</span>=<span class="dt">&quot;</span>${rotu.id}<span class="dt">&quot;</span>&gt;${rotu.nimi}&lt;/option&gt;
<span class="kw">&lt;/c:forEach&gt;</span>
&lt;/select&gt;</code></pre>
<p>Jotta esimerkki toimisi, on näkymälle tietenkin välitettävä kaikki kissarodut:</p>
<pre class="sourceCode java"><code class="sourceCode java">request.<span class="fu">setAttribute</span>(<span class="st">&quot;kissarodut&quot;</span>, Kissarodut.<span class="fu">haeKaikki</span>());</code></pre>
<p>Lopputulos näyttää osapuilleen seuraavalta ja on hyvin helppokäyttöinen:</p>
<p><label>Rotu</label> <select name="rotu_id"> <option value="1">Maatiaiskissa</option> <option value="2">Persialainen</option> <option value="3">Kissabussi</option> <option value="4">Siperiankissa</option> <option value="5">Pyhä birma</option> <option value="6">Elävä lelutiikeri</option> </select></p>
</section>
<section id="sessionmessages" class="level3">
<h3>Viestien näyttäminen lisäyksen jälkeen</h3>
<p>Lisäyksen onnistuttua lomake ohjaa selaimen listaussivulle. Onnistumisesta näytetään tällöin käyttäjälle viesti.</p>
<p>Jos käytät <code>sendRedirect</code>-metodia siirtymiseen sivulta toiselle, tarvitset tavan välittää siirryttävälle sivulle viestejä. Tähän tarkoitukseen istunto on mitä kätevin työkalu:</p>
<p><strong>Kontrollerissa</strong></p>
<pre class="sourceCode java"><code class="sourceCode java">  <span class="co">//Lisätään kantaan kissa:</span>
  uusikatti.<span class="fu">lisaaKantaan</span>();

  <span class="co">//Asetetaan istuntoon ilmoitus siitä, että kissa on lisätty:</span>
  HttpSession session = request.<span class="fu">getSession</span>();
  session.<span class="fu">setAttribute</span>(<span class="st">&quot;ilmoitus&quot;</span>, <span class="st">&quot;Kissa lisätty onnistuneesti.&quot;</span>);

  <span class="co">//Lähetetään käyttäjä eteenpäin listasivulle:</span>
  response.<span class="fu">sendRedirect</span>(<span class="st">&quot;kissalista&quot;</span>);</code></pre>
<p>Istuntoon asetettu virhe näytetään seuraavalla käyttäjän avaamalla sivulla. Toteutuksen voi tehdä esim. omana kirjastofunktionaan</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="dt">void</span> <span class="fu">haeIlmoitus</span>(HttpServletRequest request) {
  HttpSession session = request.<span class="fu">getSession</span>();
  String ilmoitus = session.<span class="fu">getAttribute</span>(<span class="st">&quot;ilmoitus&quot;</span>);

  <span class="kw">if</span> (ilmoitus != <span class="kw">null</span>) {
    <span class="co">// Samalla kun viesti haetaan, se poistetaan istunnosta,</span>
    <span class="co">// ettei se näkyisi myöhemmin jollain toisella sivulla uudestaan.</span>
    session.<span class="fu">removeAttribute</span>(<span class="st">&quot;ilmoitus&quot;</span>);

    request.<span class="fu">setAttribute</span>(<span class="st">&quot;ilmoitus&quot;</span>, ilmoitus);
  }
}</code></pre>
<p>Viestin hakemisen jälkeen on tietenkin huolehdittava siitä, ettei viesti jää istuntoon roikkumaan, joten se poistetaan istunnosta heti. Itse virhe taas näytetään pohjatiedostossa olevalla koodilla:</p>
<p><strong>Näkymien pohjatiedostossa</strong></p>
<pre class="sourceCode jsp"><code class="sourceCode jsp"><span class="kw">&lt;c:if</span><span class="ot"> test</span>=<span class="dt">&quot;</span>${ilmoitus != <span class="kw">null</span>}<span class="dt">&quot;</span><span class="kw">&gt;</span>
  &lt;div<span class="ot"> class</span>=<span class="dt">&quot;alert alert-info&quot;</span>&gt;${ilmoitus}&lt;/div&gt;
<span class="kw">&lt;/c:if&gt;</span></code></pre>
<p>Tämänkaltaisen koodin ympärille kannattaa yleensä rakentaa jonkinlainen oma rajapintansa.</p>
<section class="alert alert-success small"><h3>
Seuraavaksi:
</h3>
<p>Kun lisäys on toteutettu, sen pohjalta voidaan toteuttaa myös <a href="muokkausnakymat.html">muokkauslomake</a>.</p>
</section>




</section>
</section>
</div>
</div> 
</div> 
<footer>
  <a href="../../sivukartta.html">Sivukartta</a> - 
  <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text" property="dct:title" rel="dct:type">AdvancedKittenry</span> 
  by
  <a xmlns:cc="http://creativecommons.org/ns#" href="http://advancedkittenry.github.io/credits.html" property="cc:attributionName" rel="cc:attributionURL">David Consuegra and others</a>
  is licensed under a 
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">
    <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-sa/3.0/80x15.png" />
  </a>
</footer>
</body>
</html>
